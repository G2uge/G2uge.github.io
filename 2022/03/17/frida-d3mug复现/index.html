<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>frida+d3mug复现 | Gruge's Blog</title><meta name="keywords" content="复现,frida"><meta name="author" content="Gruge"><meta name="copyright" content="Gruge"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="FRIDA-API使用篇frida中有五种对象，分别是Java、Interceptor、NativePointer、NativeFunction、NativeCallback对象 这些都是在编写frida脚本的时候会用到的对象以及对应的函数。 frida知识更多的学习，可以查看这些文章 Java对象无论是想对so层亦或java层进行拦截，都必须编写Java.perform，java对象是很重要的">
<meta property="og:type" content="article">
<meta property="og:title" content="frida+d3mug复现">
<meta property="og:url" content="http://example.com/2022/03/17/frida-d3mug%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="Gruge's Blog">
<meta property="og:description" content="FRIDA-API使用篇frida中有五种对象，分别是Java、Interceptor、NativePointer、NativeFunction、NativeCallback对象 这些都是在编写frida脚本的时候会用到的对象以及对应的函数。 frida知识更多的学习，可以查看这些文章 Java对象无论是想对so层亦或java层进行拦截，都必须编写Java.perform，java对象是很重要的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s3.bmp.ovh/imgs/2022/02/ca6f47126f533a59.jpg">
<meta property="article:published_time" content="2022-03-17T04:21:15.000Z">
<meta property="article:modified_time" content="2022-03-17T04:24:50.793Z">
<meta property="article:author" content="Gruge">
<meta property="article:tag" content="复现">
<meta property="article:tag" content="frida">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s3.bmp.ovh/imgs/2022/02/ca6f47126f533a59.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2022/03/17/frida-d3mug%E5%A4%8D%E7%8E%B0/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'frida+d3mug复现',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-17 12:24:50'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/modify.css"><meta name="generator" content="Hexo 5.4.1"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2022/02/463b631c6a0f63ec.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">28</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s3.bmp.ovh/imgs/2022/02/ca6f47126f533a59.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Gruge's Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">frida+d3mug复现</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-03-17T04:21:15.000Z" title="发表于 2022-03-17 12:21:15">2022-03-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-03-17T04:24:50.793Z" title="更新于 2022-03-17 12:24:50">2022-03-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/">安卓逆向</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="frida+d3mug复现"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><div class="top-img" style="background-image: url('https://s3.bmp.ovh/imgs/2022/02/ca6f47126f533a59.jpg');"></div><article class="post-content" id="article-container"><h1 id="FRIDA-API使用篇"><a href="#FRIDA-API使用篇" class="headerlink" title="FRIDA-API使用篇"></a>FRIDA-API使用篇</h1><p>frida中有五种对象，分别是Java、Interceptor、NativePointer、NativeFunction、NativeCallback对象</p>
<p>这些都是在编写frida脚本的时候会用到的对象以及对应的函数。</p>
<p>frida知识更多的学习，可以查看<a target="_blank" rel="noopener" href="https://www.anquanke.com/member.html?memberId=131652">这些文章</a></p>
<h2 id="Java对象"><a href="#Java对象" class="headerlink" title="Java对象"></a>Java对象</h2><p>无论是想对<code>so</code>层亦或java层进行拦截，都必须编写<code>Java.perform</code>，java对象是很重要的</p>
<h3 id="附加调用Java-perform"><a href="#附加调用Java-perform" class="headerlink" title="附加调用Java.perform"></a>附加调用Java.perform</h3><p><code>Java.perform（fn）</code>主要用于<strong>当前线程附加到<code>Java VM</code><strong>并且</strong>调用<code>fn</code>方法</strong>。该API是非常重要的</p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">unction frida_Java() {</span><br><span class="line">    //运行当前js脚本时会对当前线程附加到Java VM虚拟机，并且执行function方法</span><br><span class="line">    Java.perform(function () {</span><br><span class="line">        //判断是否Java VM正常运行</span><br><span class="line">        if(Java.available)</span><br><span class="line">        {</span><br><span class="line">            //如不意外会直接输出 hello</span><br><span class="line">            console.log("hello");</span><br><span class="line">        }else{</span><br><span class="line">            console.log("error");</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">}       </span><br><span class="line">setImmediate(frida_Java,0);</span><br><span class="line"></span><br><span class="line">输出如下。</span><br><span class="line">[Google Pixel::com.roysue.roysueapplication]-&gt; hello</span><br></pre></td></tr></tbody></table></figure>

<h3 id="判断加载Java-available"><a href="#判断加载Java-available" class="headerlink" title="判断加载Java.available"></a>判断加载Java.available</h3><p>该函数一般用来<strong>判断</strong>当前进程是否加载了**<code>JavaVM，Dalvik</code>或<code>ART</code>虚拟机**</p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function frida_Java() {</span><br><span class="line">    Java.perform(function () {</span><br><span class="line">        //作为判断用</span><br><span class="line">        if(Java.available)</span><br><span class="line">        {</span><br><span class="line">            //注入的逻辑代码</span><br><span class="line">            console.log("hello java vm");</span><br><span class="line">        }else{</span><br><span class="line">            //未能正常加载JAVA VM</span><br><span class="line">            console.log("error");</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">}       </span><br><span class="line">setImmediate(frida_Java,0);</span><br><span class="line"></span><br><span class="line">输出如下。</span><br><span class="line">hello java vm</span><br></pre></td></tr></tbody></table></figure>

<h3 id="版本号Java-androidVersion"><a href="#版本号Java-androidVersion" class="headerlink" title="版本号Java.androidVersion"></a>版本号Java.androidVersion</h3><p>显示<strong>android系统版本号</strong></p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">function frida_Java() {</span><br><span class="line">    Java.perform(function () {</span><br><span class="line">        //作为判断用</span><br><span class="line">        if(Java.available)</span><br><span class="line">        {</span><br><span class="line">            //注入的逻辑代码</span><br><span class="line">            console.log("",Java.androidVersion);</span><br><span class="line">        }else{</span><br><span class="line">            //未能正常加载JAVA VM</span><br><span class="line">            console.log("error");</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">}       </span><br><span class="line">setImmediate(frida_Java,0);</span><br></pre></td></tr></tbody></table></figure>

<h3 id="获取类Java-use"><a href="#获取类Java-use" class="headerlink" title="获取类Java.use"></a>获取类Java.use</h3><p><code>Java.use(className)，</code>动态获取<code>className</code>的类定义，通过对其调用<code>$new()</code>来调用构造函数，可以从中<strong>实例化对象</strong>。当想要<strong>回收类</strong>时可以调用<code>$Dispose()</code>方法显式释放，当然也可以等待<code>JavaScript</code>的垃圾回收机制，当实例化一个对象之后，可以通过其<strong>实例对象调用类中的静态或非静态的方法</strong></p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(function () {</span><br><span class="line">  //获取android.app.Activity类</span><br><span class="line">  var Activity = Java.use('android.app.Activity');</span><br><span class="line">  //获取java.lang.Exception类</span><br><span class="line">  var Exception = Java.use('java.lang.Exception');</span><br><span class="line">  //拦截Activity类的onResume方法</span><br><span class="line">  Activity.onResume.implementation = function () {</span><br><span class="line">    //调用onResume方法的时候，会在此处被拦截并且调用以下代码抛出异常！</span><br><span class="line">    throw Exception.$new('Oh noes!');</span><br><span class="line">  };</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>



<h3 id="枚举类Java-enumerateLoadedClasses"><a href="#枚举类Java-enumerateLoadedClasses" class="headerlink" title="枚举类Java.enumerateLoadedClasses"></a>枚举类Java.enumerateLoadedClasses</h3><p>该API枚举当前<strong>加载的所有类信息</strong>，它有一个<strong>回调函数</strong>分别是<code>onMatch、onComplete</code>函数</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">function frida_Java() {</span><br><span class="line">    Java.perform(function () {</span><br><span class="line">        if(Java.available)</span><br><span class="line">        {</span><br><span class="line">            //console.log("",Java.androidVersion);</span><br><span class="line">            //枚举当前加载的所有类</span><br><span class="line">            Java.enumerateLoadedClasses({</span><br><span class="line">                //每一次回调此函数时其参数className就是类的信息</span><br><span class="line">                onMatch: function (className)</span><br><span class="line">                {</span><br><span class="line">                    //输出类字符串</span><br><span class="line">                    console.log("",className);</span><br><span class="line">                },</span><br><span class="line">                //枚举完毕所有类之后的回调函数</span><br><span class="line">                onComplete: function ()</span><br><span class="line">                {</span><br><span class="line">                    //输出类字符串</span><br><span class="line">                    console.log("输出完毕");</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">        }else{</span><br><span class="line">            console.log("error");</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">}       </span><br><span class="line">setImmediate(frida_Java,0);</span><br></pre></td></tr></tbody></table></figure>

<h3 id="扫描实例类Java-choose"><a href="#扫描实例类Java-choose" class="headerlink" title="扫描实例类Java.choose"></a>扫描实例类Java.choose</h3><p>在堆上查找实例化的对象，实例化对象的意思就是用这个类创建的一个对象（如同人这个类中的叫小明的这个人）</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(function () {</span><br><span class="line">    //查找android.view.View类在堆上的实例化对象</span><br><span class="line">    Java.choose("android.view.View", {</span><br><span class="line">        //枚举时调用</span><br><span class="line">        onMatch:function(instance){</span><br><span class="line">            //打印实例</span><br><span class="line">            console.log(instance);</span><br><span class="line">        },</span><br><span class="line">        //枚举完成后调用</span><br><span class="line">        onComplete:function() {</span><br><span class="line">            console.log("end")</span><br><span class="line">        }});</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">输出如下：</span><br><span class="line">android.view.View{2292774 V.ED..... ......ID 0,1794-1080,1920 #1020030 android:id/navigationBarBackground}</span><br><span class="line">android.view.View{d43549d V.ED..... ......ID 0,0-1080,63 #102002f android:id/statusBarBackground}</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>

<h3 id="类型转换器Java-cast"><a href="#类型转换器Java-cast" class="headerlink" title="类型转换器Java.cast"></a>类型转换器Java.cast</h3><p>使用 <code>Java.cast(object,Class)</code> 可以转换一个对象的类型。通常在拦截<code>so</code>层时会使用此函数将<code>jstring、jarray</code>等等转换之后查看其值。</p>
<p>示例：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">performNow</span>(<span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">var</span> <span class="title class_">Student</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">'com.example.myapplication.Student'</span>);</span><br><span class="line">  <span class="keyword">var</span> student = <span class="title class_">Student</span>.$new(<span class="string">'田所浩二'</span>,<span class="number">24</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(student.<span class="property">class</span>);</span><br><span class="line">  <span class="comment">//将Student类对象强制转化成Object类对象</span></span><br><span class="line">  student = <span class="title class_">Java</span>.<span class="title function_">cast</span>(student,<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">"java.lang.Object"</span>));</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(student.<span class="property">class</span>);</span><br><span class="line">  <span class="comment">//将上面强制转换成的Object类对象转换成Student类对象</span></span><br><span class="line">  student = <span class="title class_">Java</span>.<span class="title function_">cast</span>(student,<span class="title class_">Student</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(student.<span class="property">class</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<h3 id="定义任意数组类型Java-array"><a href="#定义任意数组类型Java-array" class="headerlink" title="定义任意数组类型Java.array"></a>定义任意数组类型Java.array</h3><p>frida提供了<strong>在js代码</strong>中定义<strong>java数组</strong>的api，该数组可以用于传递给java API。定义格式为<code>Java.array('type',[value1,value2,....]);</code></p>
<p>示例：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">        <span class="comment">//定义一个int数组、值是1003, 1005, 1007</span></span><br><span class="line">        <span class="keyword">var</span> intarr = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">'int'</span>, [ <span class="number">1003</span>, <span class="number">1005</span>, <span class="number">1007</span> ]);</span><br><span class="line">        <span class="comment">//定义一个byte数组、值是0x48, 0x65, 0x69</span></span><br><span class="line">        <span class="keyword">var</span> bytearr = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">'byte'</span>, [ <span class="number">0x48</span>, <span class="number">0x65</span>, <span class="number">0x69</span> ]);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;bytearr.<span class="property">length</span>;i++)</span><br><span class="line">        {</span><br><span class="line">            <span class="comment">//输出每个byte元素</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(bytearr[i])</span><br><span class="line">        }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Java-vm对象"><a href="#Java-vm对象" class="headerlink" title="Java.vm对象"></a>Java.vm对象</h3><p>Java.vm对象十分常用，比如想要拿到<strong>JNI层的JNIEnv对象</strong>，可以使用**getEnv()**。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function frida_Java() {     </span><br><span class="line">    Java.perform(function () {</span><br><span class="line">         //拦截getStr函数</span><br><span class="line">         Interceptor.attach(Module.findExportByName("libhello.so" , "Java_com_roysue_roysueapplication_hellojni_getStr"), {</span><br><span class="line">            onEnter: function(args) {</span><br><span class="line">                console.log("getStr");</span><br><span class="line">            },</span><br><span class="line">            onLeave:function(retval){</span><br><span class="line">                //它的返回值的是retval 在jni层getStr的返回值的jstring </span><br><span class="line">                //我们在这里做的事情就是替换掉结果</span><br><span class="line">                //先获取一个Env对象</span><br><span class="line">                var env = Java.vm.getEnv();</span><br><span class="line">                //通过newStringUtf方法构建一个jstirng字符串</span><br><span class="line">                var jstring = env.newStringUtf('roysue');</span><br><span class="line">                //replace替换掉结果</span><br><span class="line">                retval.replace(jstring);</span><br><span class="line">                console.log("getSum方法返回值为:roysue")</span><br><span class="line">            }</span><br><span class="line">    });</span><br><span class="line">}</span><br><span class="line">setImmediate(frida_Java,0);</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Interceptor对象"><a href="#Interceptor对象" class="headerlink" title="Interceptor对象"></a>Interceptor对象</h2><p>函数原型是**Interceptor.attach(target, callbacks)**：</p>
<p><strong>target参数</strong>：是需要拦截的位置的<strong>函数地址</strong>，也就是填某个**<code>so</code>层函数的地址<strong>即可对其拦截，<code>target</code>是一个</strong><code>NativePointer</code>参数**，用来指定你想要拦截的函数的地址，<code>NativePointer</code>是一个指针（下面有对NativePointer的说明）；对于<code>Thumb</code>函数需要对函数地址<code>+1</code></p>
<p><strong>callbacks参数</strong>：它的回调函数，有两个onEnter: function (args) 和 onLeave: function (retval)函数</p>
<h3 id="Interceptor-attach"><a href="#Interceptor-attach" class="headerlink" title="Interceptor.attach"></a>Interceptor.attach</h3><p><strong>两个回调函数</strong>：</p>
<ul>
<li><p><code>onEnter：</code>函数（<code>args</code>）：回调函数，给定一个参数<code>args</code>，可用于读取或写入参数作为 <code>NativePointer</code> 对象的数组。</p>
</li>
<li><p><code>onLeave：</code>函数（<code>retval</code>）：回调函数给定一个参数 <code>retval</code>，该参数是包含原始返回值的 <code>NativePointer</code> 派生对象。可以调用 <code>retval.replace（1337）</code> 以整数 <code>1337</code> 替换返回值，或者调用 <code>retval.replace（ptr（"0x1234"））</code>以替换为指针。</p>
</li>
</ul>
<p>示例：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//使用Module对象getExportByNameAPI直接获取libc.so中的导出函数read的地址，对read函数进行附加拦截</span><br><span class="line">Interceptor.attach(Module.getExportByName('libc.so', 'read'), {</span><br><span class="line">  //每次read函数调用的时候会执行onEnter回调函数</span><br><span class="line">  onEnter: function (args) {</span><br><span class="line">    this.fileDescriptor = args[0].toInt32();</span><br><span class="line">  },</span><br><span class="line">  //read函数执行完成之后会执行onLeave回调函数</span><br><span class="line">  onLeave: function (retval) {</span><br><span class="line">    if (retval.toInt32() &gt; 0) {</span><br><span class="line">      /* do something with this.fileDescriptor */</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p><strong>Interceptor.attach函数的一些属性</strong>：</p>
<ul>
<li><table>
<thead>
<tr>
<th>returnAddress</th>
<th>返回地址，类型是<code>NativePointer</code></th>
</tr>
</thead>
<tbody><tr>
<td>threadId</td>
<td>操作系统线程ID</td>
</tr>
<tr>
<td>context</td>
<td>上下文：具有键<code>pc</code>和<code>sp</code>的对象，它们是分别为<code>ia32/x64/arm</code>指定<code>EIP/RIP/PC</code>和<code>ESP/RSP/SP的NativePointer</code>对象。其他处理器特定的键也可用，例如<code>eax、rax、r0、x0</code>等。也可以通过分配给这些键来更新寄存器值。</td>
</tr>
<tr>
<td>errno</td>
<td>当前<code>errno</code>值</td>
</tr>
<tr>
<td>lastError</td>
<td>当前操作系统错误值</td>
</tr>
<tr>
<td>depth</td>
<td>相对于其他调用的调用深度</td>
</tr>
</tbody></table>
</li>
</ul>
<p>示例：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Interceptor.attach(Module.findExportByName("libhello.so" , "Java_com_roysue_roysueapplication_hellojni_getSum"), {</span><br><span class="line">            onEnter: function(args) {</span><br><span class="line">                //输出</span><br><span class="line">                console.log('Context information:');</span><br><span class="line">                //输出上下文因其是一个Objection对象，需要它进行接送、转换才能正常看到值</span><br><span class="line">                console.log('Context  : ' + JSON.stringify(this.context));</span><br><span class="line">                //输出返回地址</span><br><span class="line">                console.log('Return   : ' + this.returnAddress);</span><br><span class="line">                //输出线程id</span><br><span class="line">                console.log('ThreadId : ' + this.threadId);</span><br><span class="line">                console.log('Depth    : ' + this.depth);</span><br><span class="line">                console.log('Errornr  : ' + this.err);</span><br><span class="line">            },</span><br><span class="line">            onLeave:function(retval){</span><br><span class="line">            }</span><br><span class="line">        });</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Interceptor-detachAll"><a href="#Interceptor-detachAll" class="headerlink" title="Interceptor.detachAll"></a>Interceptor.detachAll</h3><p>简单来说这个的函数的作用就是让之前所有的<code>Interceptor.attach</code>附加拦截的回调函数失效</p>
<h3 id="Interceptor-replace"><a href="#Interceptor-replace" class="headerlink" title="Interceptor.replace"></a>Interceptor.replace</h3><p>相当于<strong>替换掉原本的函数</strong>，用替换时的实现替换目标处的函数。如果想要完全或部分替换现有函数的实现，则通常使用此函数。</p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function frida_Interceptor() {</span><br><span class="line">    Java.perform(function () {</span><br><span class="line">       //这个c_getSum方法有两个int参数、返回结果为两个参数相加</span><br><span class="line">       //这里用NativeFunction函数自己定义了一个c_getSum函数</span><br><span class="line">       var add_method = new NativeFunction(Module.findExportByName('libhello.so', 'c_getSum'), </span><br><span class="line">       'int',['int','int']);</span><br><span class="line">       //输出结果 那结果肯定就是 3</span><br><span class="line">       console.log("result:",add_method(1,2));</span><br><span class="line">       //这里对原函数的功能进行替换实现</span><br><span class="line">       Interceptor.replace(add_method, new NativeCallback(function (a, b) {</span><br><span class="line">           //h不论是什么参数都返回123</span><br><span class="line">            return 123;</span><br><span class="line">       }, 'int', ['int', 'int']));</span><br><span class="line">       //再次调用 则返回123</span><br><span class="line">       console.log("result:",add_method(1,2));</span><br><span class="line">    });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="NativePointer对象"><a href="#NativePointer对象" class="headerlink" title="NativePointer对象"></a>NativePointer对象</h2><p>同等与C语言中的指针</p>
<h3 id="new-NativePointer-s"><a href="#new-NativePointer-s" class="headerlink" title="new NativePointer(s)"></a>new NativePointer(s)</h3><p>声明定义NativePointer类型</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const ptr1 = new NativePointer("100");</span><br><span class="line">console.log("ptr1:",ptr1);</span><br></pre></td></tr></tbody></table></figure>

<h3 id="运算符以及指针读写API"><a href="#运算符以及指针读写API" class="headerlink" title="运算符以及指针读写API"></a>运算符以及指针读写API</h3><p>这里有个表，可以用这个指针对这些API进行调用</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://p3.ssl.qhimg.com/t0135a7319c873d8d52.png" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://p3.ssl.qhimg.com/t01821e14d1331f0aef.png" alt="img"></p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 用readByteArray函数来读取libc.so文件在内存中的数据</span><br><span class="line">var pointer = Process.findModuleByName("libc.so").base;</span><br><span class="line">//读取从pointer地址开始的16个字节 (从libc文件读取0x10个字节的长度)</span><br><span class="line">console.log(pointer.readByteArray(0x10));</span><br></pre></td></tr></tbody></table></figure>

<p>上面这些API的调用的部分示例可以查看<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/195869#h2-13">这篇文章</a>中的NativePointer对象这个部分</p>
<h2 id="NativeFunction对象"><a href="#NativeFunction对象" class="headerlink" title="NativeFunction对象"></a>NativeFunction对象</h2><p>作用：调用<code>address</code>处的函数(用<code>NativePointer</code>指定)</p>
<p>函数定义格式：new NativeFunction(address, returnType, argTypes[, options])</p>
<ul>
<li><strong>returnType和argTypes[，]中能够填写的数据类型</strong>：void、pointer、int、uint、long、ulong、char、uchar、float、double、int8、uint8、int16、uint16、int32、uint32、int64、uint64这些类型。假设有<strong>三个参数</strong>都是<code>int</code>，则<strong>new NativeFunction(address, returnType, [‘int’, ‘int’, ‘int’])</strong></li>
<li>定义的时候必须要将<strong>参数类型个数</strong>和<strong>参数类型</strong>以及<strong>返回值</strong>完全匹配。</li>
<li>并且第一个参数一定要是<strong>函数地址指针</strong></li>
</ul>
<p>示例：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// LargeObject HandyClass::friendlyFunctionName();</span><br><span class="line">//创建friendlyFunctionPtr地址的函数</span><br><span class="line">var friendlyFunctionName = new NativeFunction(friendlyFunctionPtr,</span><br><span class="line">    'void', ['pointer', 'pointer']);</span><br><span class="line">//申请内存空间    </span><br><span class="line">var returnValue = Memory.alloc(sizeOfLargeObject);</span><br><span class="line">//调用friendlyFunctionName函数</span><br><span class="line">friendlyFunctionName(returnValue, thisPtr);</span><br></pre></td></tr></tbody></table></figure>

<h2 id="NativeCallback对象"><a href="#NativeCallback对象" class="headerlink" title="NativeCallback对象"></a>NativeCallback对象</h2><p>作用：创建一个回调函数</p>
<p>函数定义格式：new NativeCallback(func，rereturn Type，argTypes[，ABI])</p>
<ul>
<li>func参数：由JavaScript函数实现的函数</li>
<li><code>rereturn Type</code>指定返回类型，<code>argTypes</code>数组指定参数类型</li>
</ul>
<p>当将产生的回调与<code>Interceptor.replace()</code>一起使用时，将调用func，并将其绑定到具有一些有用属性的对象，就像<code>Interceptor.Attach()</code>中的那样</p>
<p>示例：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line"><span class="comment">//替换对象的函数指针</span></span><br><span class="line">   <span class="keyword">var</span> add_method = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">'libhello.so'</span>, <span class="string">'c_getSum'</span>), </span><br><span class="line">   <span class="string">'int'</span>,[<span class="string">'int'</span>,<span class="string">'int'</span>]);</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"result:"</span>,<span class="title function_">add_method</span>(<span class="number">1</span>,<span class="number">2</span>));</span><br><span class="line">   <span class="comment">//在这里new一个新的函数，但是参数的个数和返回值必须对应</span></span><br><span class="line">   <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(add_method, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">a, b</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">123</span>;</span><br><span class="line">   }, <span class="string">'int'</span>, [<span class="string">'int'</span>, <span class="string">'int'</span>]));</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"result:"</span>,<span class="title function_">add_method</span>(<span class="number">1</span>,<span class="number">2</span>));</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p>使用java.perform()中写入js脚本</p>
<p>使用Module对象获得一些so文件的地址信息</p>
<p>利用so文件的地址信息使用NativeFunction 得到so文件之中的对象，再使用Interceptor对象的API，对相应的函数进行一定的操作</p>
<p>运行这个函数，设置这个函数的输入的参数，设置这个函数的返回的参数</p>
<h1 id="FRIDA-API使用篇：rpc、Process、Module、Memory"><a href="#FRIDA-API使用篇：rpc、Process、Module、Memory" class="headerlink" title="FRIDA-API使用篇：rpc、Process、Module、Memory"></a>FRIDA-API使用篇：rpc、Process、Module、Memory</h1><p>这里对frida官方的一些非常常用的<code>API</code>进行介绍</p>
<h2 id="FRIDA输出打印"><a href="#FRIDA输出打印" class="headerlink" title="FRIDA输出打印"></a>FRIDA输出打印</h2><p>在官方API有两种打印的方式，分别是<code>console</code>、<code>send</code></p>
<h3 id="console输出"><a href="#console输出" class="headerlink" title="console输出"></a>console输出</h3><p>在<code>FRIDA</code>的<code>console</code>中有三个级别分别是<code>log、warn、error</code>。一般在使用中我们只会使用<code>log</code>来输出想看的值。</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hello_printf</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">""</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"hello-log"</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"hello-warn"</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"hello-error"</span>);</span><br><span class="line">    });</span><br><span class="line">}</span><br><span class="line"><span class="title function_">setImmediate</span>(hello_printf,<span class="number">0</span>);</span><br></pre></td></tr></tbody></table></figure>

<h4 id="console之hexdump"><a href="#console之hexdump" class="headerlink" title="console之hexdump"></a>console之hexdump</h4><p>hexdump的含义:<strong>打印内存中的地址</strong>，target参数可以是<strong>ArrayBuffer</strong>或者<strong>NativePointer</strong>,而<strong>options参数</strong>则是自定义输出格式可以填这几个参数offset、lengt、header、ansi</p>
<p>示例：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> libc = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">'libc.so'</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(libc, {</span><br><span class="line">  <span class="attr">offset</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">length</span>: <span class="number">64</span>,</span><br><span class="line">  <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">ansi</span>: <span class="literal">true</span></span><br><span class="line">}));</span><br></pre></td></tr></tbody></table></figure>

<p>执行效果:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">           0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F  0123456789ABCDEF</span><br><span class="line">00000000  7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00  .ELF............</span><br><span class="line">00000010  03 00 28 00 01 00 00 00 00 00 00 00 34 00 00 00  ..(.........4...</span><br><span class="line">00000020  34 a8 04 00 00 00 00 05 34 00 20 00 08 00 28 00  4.......4. ...(.</span><br><span class="line">00000030  1e 00 1d 00 06 00 00 00 34 00 00 00 34 00 00 00  ........4...4...</span><br></pre></td></tr></tbody></table></figure>

<h3 id="send"><a href="#send" class="headerlink" title="send"></a><strong>send</strong></h3><p>原理：send是在<strong>python层</strong>定义的<strong>on_message回调函数</strong>，jscode内所有的信息都被监控<strong>script.on(‘message’, on_message)<strong>，当</strong>输出信息</strong>的时候on_message函数会拿到其数据再通过format转换、</p>
<p>输出效果：能够直接将数据以**<code>json</code>格式**输出，当然数据是二进制的时候也依然是可以使用<code>send</code></p>
<p>示例：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">def <span class="title function_">on_message</span>(message, data):</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">'type'</span>] == <span class="string">'send'</span>:</span><br><span class="line">        <span class="title function_">print</span>(<span class="string">"[*] {0}"</span>.<span class="title function_">format</span>(message[<span class="string">'payload'</span>]))</span><br><span class="line">    <span class="attr">else</span>:</span><br><span class="line">        <span class="title function_">print</span>(message)</span><br><span class="line"></span><br><span class="line">jscode = <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">    Java.perform(function () </span></span><br><span class="line"><span class="string">    {</span></span><br><span class="line"><span class="string">        var jni_env = Java.vm.getEnv();</span></span><br><span class="line"><span class="string">        console.log(jni_env);</span></span><br><span class="line"><span class="string">        send(jni_env);</span></span><br><span class="line"><span class="string">    });</span></span><br><span class="line"><span class="string"> "</span><span class="string">""</span></span><br><span class="line"></span><br><span class="line">process = frida.<span class="title function_">get_usb_device</span>().<span class="title function_">attach</span>(<span class="string">'com.roysue.roysueapplication'</span>)</span><br><span class="line">script = process.<span class="title function_">create_script</span>(jscode)</span><br><span class="line">script.<span class="title function_">on</span>(<span class="string">'message'</span>, on_message)</span><br><span class="line">script.<span class="title function_">load</span>()</span><br><span class="line">sys.<span class="property">stdin</span>.<span class="title function_">read</span>()</span><br></pre></td></tr></tbody></table></figure>

<p>效果：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">roysue@ubuntu:~/Desktop/Chap09$ python Chap03.py </span><br><span class="line">[object Object]</span><br><span class="line">[*] {'handle': '0xdf4f8000', 'vm': {}}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="FRIDA变量类型"><a href="#FRIDA变量类型" class="headerlink" title="FRIDA变量类型"></a>FRIDA变量类型</h2><p>在脚本之中如何声明变量类型。以及<code>frida</code>为<code>Int64(v)</code>提供了一些相关的API的使用</p>
<h3 id="声明变量类型"><a href="#声明变量类型" class="headerlink" title="声明变量类型"></a>声明变量类型</h3><table>
<thead>
<tr>
<th>索引</th>
<th>API</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>new Int64(v)</td>
<td>定义一个有符号Int64类型的变量值为v，参数v可以是字符串或者以0x开头的的十六进制值</td>
</tr>
<tr>
<td>2</td>
<td>new UInt64(v)</td>
<td>定义一个无符号Int64类型的变量值为v，参数v可以是字符串或者以0x开头的的十六进制值</td>
</tr>
<tr>
<td>3</td>
<td>new NativePointer(s)</td>
<td>定义一个指针，指针地址为s</td>
</tr>
<tr>
<td>4</td>
<td>ptr(“0”)</td>
<td>同上</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">""</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"new Int64(1):"</span>+<span class="keyword">new</span> <span class="title class_">Int64</span>(<span class="number">1</span>));</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"new UInt64(1):"</span>+<span class="keyword">new</span> <span class="title class_">UInt64</span>(<span class="number">1</span>));</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"new NativePointer(0xEC644071):"</span>+<span class="keyword">new</span> <span class="title class_">NativePointer</span>(<span class="number">0xEC644071</span>));</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"new ptr('0xEC644071'):"</span>+<span class="keyword">new</span> <span class="title function_">ptr</span>(<span class="number">0xEC644071</span>));</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Int64-v-使用的API"><a href="#Int64-v-使用的API" class="headerlink" title="Int64(v)使用的API"></a>Int64(v)使用的API</h3><table>
<thead>
<tr>
<th>索引</th>
<th>API</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>add(rhs)、sub(rhs)、and(rhs)、or(rhs)、xor(rhs)</td>
<td>加、减、逻辑运算</td>
</tr>
<tr>
<td>2</td>
<td>shr(N)、shl(n)</td>
<td>向右/向左移位n位生成新的Int64</td>
</tr>
<tr>
<td>3</td>
<td>Compare(Rhs)</td>
<td>返回整数比较结果</td>
</tr>
<tr>
<td>4</td>
<td>toNumber()</td>
<td>转换为数字</td>
</tr>
<tr>
<td>5</td>
<td>toString([radix=10])</td>
<td>转换为可选基数的字符串(默认为10)</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hello_type</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">""</span>);</span><br><span class="line">        <span class="comment">//8888 + 1 = 8889</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"8888 + 1:"</span>+<span class="keyword">new</span> <span class="title class_">Int64</span>(<span class="string">"8888"</span>).<span class="title function_">add</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="comment">//8888 - 1 = 8887</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"8888 - 1:"</span>+<span class="keyword">new</span> <span class="title class_">Int64</span>(<span class="string">"8888"</span>).<span class="title function_">sub</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="comment">//8888 &lt;&lt; 1 = 4444</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"8888 &lt;&lt; 1:"</span>+<span class="keyword">new</span> <span class="title class_">Int64</span>(<span class="string">"8888"</span>).<span class="title function_">shr</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="comment">//8888 == 22 = 1 1是false</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"8888 == 22:"</span>+<span class="keyword">new</span> <span class="title class_">Int64</span>(<span class="string">"8888"</span>).<span class="title function_">compare</span>(<span class="number">22</span>));</span><br><span class="line">        <span class="comment">//转string</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"8888 toString:"</span>+<span class="keyword">new</span> <span class="title class_">Int64</span>(<span class="string">"8888"</span>).<span class="title function_">toString</span>());</span><br><span class="line">    });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Process对象"><a href="#Process对象" class="headerlink" title="Process对象"></a>Process对象</h2><p>介绍以及使用一些<code>Process</code>对象中比较常用的<code>api</code></p>
<h3 id="Process-id"><a href="#Process-id" class="headerlink" title="Process.id"></a>Process.id</h3><p>Process.id：返回附加<strong>目标进程的PID</strong></p>
<h3 id="Process-isDebuggerAttached"><a href="#Process-isDebuggerAttached" class="headerlink" title="Process.isDebuggerAttached()"></a>Process.isDebuggerAttached()</h3><p><strong>检测</strong>当前是否对目标程序已经附加</p>
<h3 id="Process-enumerateModules"><a href="#Process-enumerateModules" class="headerlink" title="Process.enumerateModules()"></a>Process.enumerateModules()</h3><p><strong>枚举</strong>当前加载的<strong>模块</strong>，返回模块对象的数组。会枚举当前所有已加载的<code>so</code>模块，并且返回了数组<code>Module</code>对象。</p>
<p>枚举得到的每个module对象，再使用每个module对象进行操作</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_Process</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">var</span> process_Obj_Module_Arr = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; process_Obj_Module_Arr.<span class="property">length</span>; i++) {</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">""</span>,process_Obj_Module_Arr[i].<span class="property">name</span>);<span class="comment">//这里使用了module的name属性</span></span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">}</span><br><span class="line"><span class="title function_">setImmediate</span>(frida_Process,<span class="number">0</span>);</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Process-enumerateThreads"><a href="#Process-enumerateThreads" class="headerlink" title="Process.enumerateThreads()"></a>Process.enumerateThreads()</h3><p>枚举当前所有的线程，返回包含以下属性的对象数组：</p>
<table>
<thead>
<tr>
<th align="left">索引</th>
<th align="left">属性</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">id</td>
<td align="left">线程id</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">state</td>
<td align="left">当前运行状态有running, stopped, waiting, uninterruptible or halted</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">context</td>
<td align="left">带有键pc和sp的对象，它们是分别为ia32/x64/arm指定EIP/RIP/PC和ESP/RSP/SP的NativePointer对象。也可以使用其他处理器特定的密钥，例如eax、rax、r0、x0等。</td>
</tr>
</tbody></table>
<h3 id="Process-getCurrentThreadId"><a href="#Process-getCurrentThreadId" class="headerlink" title="Process.getCurrentThreadId()"></a>Process.getCurrentThreadId()</h3><p>获取此线程的操作系统特定 <code>ID</code> 作为数字</p>
<h2 id="Module对象"><a href="#Module对象" class="headerlink" title="Module对象"></a>Module对象</h2><p>获得程序中函数 类等的一些信息的时候（基地址，偏移地址等）就会用到这个对象</p>
<h3 id="Module对象的属性"><a href="#Module对象的属性" class="headerlink" title="Module对象的属性"></a>Module对象的属性</h3><table>
<thead>
<tr>
<th>索引</th>
<th>属性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>name</td>
<td>模块名称</td>
</tr>
<tr>
<td>2</td>
<td>base</td>
<td>模块地址，其变量类型为NativePointer</td>
</tr>
<tr>
<td>3</td>
<td>size</td>
<td>大小</td>
</tr>
<tr>
<td>4</td>
<td>path</td>
<td>完整文件系统路径</td>
</tr>
</tbody></table>
<h3 id="Module对象的API"><a href="#Module对象的API" class="headerlink" title="Module对象的API"></a>Module对象的API</h3><table>
<thead>
<tr>
<th>索引</th>
<th>API</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Module.load()</td>
<td>加载指定so文件，返回一个Module对象</td>
</tr>
<tr>
<td>2</td>
<td>enumerateImports()</td>
<td>枚举所有Import库函数，返回Module数组对象</td>
</tr>
<tr>
<td>3</td>
<td>enumerateExports()</td>
<td>枚举所有Export库函数，返回Module数组对象</td>
</tr>
<tr>
<td>4</td>
<td>enumerateSymbols()</td>
<td>枚举所有Symbol库函数，返回Module数组对象</td>
</tr>
<tr>
<td>5</td>
<td>Module.findExportByName(exportName)、Module.getExportByName(exportName)</td>
<td>寻找指定so中export库中的函数地址</td>
</tr>
<tr>
<td>6</td>
<td>Module.findBaseAddress(name)、Module.getBaseAddress(name)</td>
<td>返回so的基地址</td>
</tr>
</tbody></table>
<h3 id="enumerateImports"><a href="#enumerateImports" class="headerlink" title="enumerateImports()"></a>enumerateImports()</h3><p>该API会枚举模块中所有中的所有Import函数</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const hooks = Module.load('libhello.so');</span><br><span class="line">var Imports = hooks.enumerateImports();//再遍历这个得到的枚举数组</span><br></pre></td></tr></tbody></table></figure>

<h3 id="enumerateExports"><a href="#enumerateExports" class="headerlink" title="enumerateExports()"></a>enumerateExports()</h3><p>该API会枚举模块中所有中的所有<code>Export</code>函数</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const hooks = Module.load('libhello.so');</span><br><span class="line">var Exports = hooks.enumerateExports();</span><br></pre></td></tr></tbody></table></figure>

<h3 id="enumerateSymbols"><a href="#enumerateSymbols" class="headerlink" title="enumerateSymbols()"></a>enumerateSymbols()</h3><p>该API会枚举模块中所有中的所有symbols 符号，使用symbols 符号可以定位native方法。返回的是一个数组对象</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const hooks = Module.load('libc.so');</span><br><span class="line">var Symbol = hooks.enumerateSymbols();</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Module-findExportByName-exportName-Module-getExportByName-exportName"><a href="#Module-findExportByName-exportName-Module-getExportByName-exportName" class="headerlink" title="Module.findExportByName(exportName), Module.getExportByName(exportName)"></a>Module.findExportByName(exportName), Module.getExportByName(exportName)</h3><p>返回<code>so</code>文件中<code>Export</code>函数库中函数名称为**<code>exportName</code>函数<strong>的</strong>绝对地址**</p>
<p>这个方法只适用于Export函数</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">'libhello.so'</span>, <span class="string">'c_getStr'</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Java_com_roysue_roysueapplication_hellojni_getStraddress:"</span>,<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">'libhello.so'</span>, <span class="string">'Java_com_roysue_roysueapplication_hellojni_getStr'</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Java_com_roysue_roysueapplication_hellojni_getStraddress:"</span>,<span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">'libhello.so'</span>, <span class="string">'Java_com_roysue_roysueapplication_hellojni_getStr'</span>));</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h3 id="Module-findBaseAddress-name-、Module-getBaseAddress-name"><a href="#Module-findBaseAddress-name-、Module-getBaseAddress-name" class="headerlink" title="Module.findBaseAddress(name)、Module.getBaseAddress(name)"></a>Module.findBaseAddress(name)、Module.getBaseAddress(name)</h3><p>返回<code>name</code>模块的基地址</p>
<p>示例：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">"libhello.so"</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"so address:"</span>,<span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(name));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"so address:"</span>,<span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(name));</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Memory对象"><a href="#Memory对象" class="headerlink" title="Memory对象"></a>Memory对象</h2><p><code>Memory</code>的一些<code>API</code>的作用：通常是对内存处理，譬如<code>Memory.copy()</code>复制内存</p>
<h3 id="Memory-scan搜索内存数据"><a href="#Memory-scan搜索内存数据" class="headerlink" title="Memory.scan搜索内存数据"></a>Memory.scan搜索内存数据</h3><p>功能：搜索内存中以<code>address</code>地址开始，搜索长度为<code>size</code>，需要搜是条件是<code>pattern，callbacks</code>搜索之后的回调函数</p>
<p>格式：Memory.scan(module.base, module.size, pattern，callbacks）</p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(function () {</span><br><span class="line">        //先获取so的module对象</span><br><span class="line">        var module = Process.findModuleByName("libhello.so"); </span><br><span class="line">        //??是通配符</span><br><span class="line">        var pattern = "03 49 ?? 50 20 44";</span><br><span class="line">        //基址</span><br><span class="line">        console.log("base:"+module.base)</span><br><span class="line">        //从so的基址开始搜索，搜索大小为so文件的大小，搜指定条件03 49 ?? 50 20 44的数据</span><br><span class="line">        var res = Memory.scan(module.base, module.size, pattern, {</span><br><span class="line">            onMatch: function(address, size){</span><br><span class="line">                //搜索成功</span><br><span class="line">                console.log('搜索到 ' +pattern +" 地址是:"+ address.toString());  </span><br><span class="line">            }, </span><br><span class="line">            onError: function(reason){</span><br><span class="line">                //搜索失败</span><br><span class="line">                console.log('搜索失败');</span><br><span class="line">            },</span><br><span class="line">            onComplete: function()</span><br><span class="line">            {</span><br><span class="line">                //搜索完毕</span><br><span class="line">                console.log("搜索完毕")</span><br><span class="line">            }</span><br><span class="line">          });</span><br><span class="line">    });</span><br></pre></td></tr></tbody></table></figure>

<h3 id="内存分配Memory-alloc"><a href="#内存分配Memory-alloc" class="headerlink" title="内存分配Memory.alloc"></a>内存分配Memory.alloc</h3><p>作用：在目标进程中的堆上<strong>申请<code>size</code>大小的内存</strong>，并且会按照<code>Process.pageSize</code>对齐，返回一个<code>NativePointer</code>，并且申请的内存如果在<code>JavaScript</code>里面没有对这个内存的使用的时候会自动释放的。</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> r = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">10</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(r, {</span><br><span class="line">            <span class="attr">offset</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">length</span>: <span class="number">10</span>,</span><br><span class="line">            <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">ansi</span>: <span class="literal">false</span></span><br><span class="line">        }));</span><br></pre></td></tr></tbody></table></figure>

<h3 id="内存复制Memory-copy"><a href="#内存复制Memory-copy" class="headerlink" title="内存复制Memory.copy"></a>内存复制Memory.copy</h3><p>示例：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//申请一个内存空间大小为10个字节</span></span><br><span class="line"><span class="keyword">const</span> r = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">10</span>);</span><br><span class="line"><span class="comment">//复制以module.base地址开始的10个字节 那肯定会是7F 45 4C 46...因为一个ELF文件的Magic属性如此。</span></span><br><span class="line"><span class="title class_">Memory</span>.<span class="title function_">copy</span>(r,<span class="variable language_">module</span>.<span class="property">base</span>,<span class="number">10</span>);</span><br></pre></td></tr></tbody></table></figure>

<h3 id="写入内存Memory-writeByteArray’"><a href="#写入内存Memory-writeByteArray’" class="headerlink" title="写入内存Memory.writeByteArray’"></a>写入内存Memory.writeByteArray’</h3><p>将字节数组<strong>写入一个指定内存</strong></p>
<p>示例：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义需要写入的字节数组 这个字节数组是字符串"roysue"的十六进制</span></span><br><span class="line"><span class="keyword">var</span> arr = [ <span class="number">0x72</span>, <span class="number">0x6F</span>, <span class="number">0x79</span>, <span class="number">0x73</span>, <span class="number">0x75</span>, <span class="number">0x65</span>];</span><br><span class="line"><span class="comment">//申请一个新的内存空间 返回指针 大小是arr.length</span></span><br><span class="line"><span class="keyword">const</span> r = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(arr.<span class="property">length</span>);</span><br><span class="line"><span class="comment">//将arr数组写入R地址中</span></span><br><span class="line"><span class="title class_">Memory</span>.<span class="title function_">writeByteArray</span>(r,arr);</span><br></pre></td></tr></tbody></table></figure>

<h3 id="读取内存Memory-readByteArray"><a href="#读取内存Memory-readByteArray" class="headerlink" title="读取内存Memory.readByteArray"></a>读取内存Memory.readByteArray</h3><p>这个函数的第一个参数传入的是 NativePointer 类型的地址指针</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//读取r指针，长度是arr.length 也就是会打印上面一样的值</span><br><span class="line">var buffer = Memory.readByteArray(r, arr.length);</span><br></pre></td></tr></tbody></table></figure>

<p>参考文章：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/195215#h2-1">FRIDA-API使用篇：rpc、Process、Module、Memory使用方法及示例 - 安全客</a></p>
<h1 id="frida的so函数hook"><a href="#frida的so函数hook" class="headerlink" title="frida的so函数hook"></a>frida的so函数hook</h1><p>so文件之中的函数有导出函数和非导出函数,导出函数打开IDA后能够在导出表中找到的函数就是导出函数，未导出函数则在导出表中寻找不到。一般来说<strong>静态编写的native函数都能在导出表中寻找到，而动态加载的则无法在导出表中发现</strong></p>
<p>在IDA的Exports页面之中查看导出函数窗口</p>
<p>示例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220315233226275.png" alt="image-20220315233226275"></p>
<p><strong>导出函数hook</strong>：导出函数窗口可以看到导出函数的函数名，偏移量 。导出函数的hook可以通过<strong>函数名</strong>或者<strong>偏移量</strong>。</p>
<p><strong>非导出函数hook</strong>：只能通过<strong>地址hook</strong>。定位到函数的位置，直接看它的偏移量即可</p>
<h2 id="通过函数地址获取指定-so-文件的函数"><a href="#通过函数地址获取指定-so-文件的函数" class="headerlink" title="通过函数地址获取指定 so 文件的函数"></a>通过函数地址获取指定 so 文件的函数</h2><p><strong>函数地址 = so基地址 + 函数偏移</strong>(如果Thumb 指令， hook 的偏移地址需要进行 <strong>+1 操作</strong>)</p>
<p><strong>IDA 判断 Thumb 指令集和 Arm指令集</strong></p>
<ul>
<li><strong>IDA - Options - General - number of opcode bytes</strong> - 设置为 4</li>
<li>此时查看 IDA VIew 中 opcode 的长度, 如果出现 <strong>2 个字节</strong>和 <strong>4 个字节</strong>的, 说明为 <strong>thumb 指令集</strong></li>
<li>如果都是 <strong>4 个字节</strong>的, 说明是 <strong>arm 指令集</strong>;</li>
<li>在 Thumb 指令集下, inline hook 的偏移地址需要进行 +1 操作;</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var str_name_so = "libjnitest.so";    //需要hook的so名</span><br><span class="line">var n_addr_func_offset = 0x00000680;         //需要hook的函数的偏移</span><br><span class="line">var n_addr_so = Module.findBaseAddress(str_name_so); //加载到内存后 函数地址 = so地址 + 函数偏移</span><br><span class="line">var n_addr_func = parseInt(n_addr_so, 16) + n_addr_func_offset;</span><br><span class="line">var ptr_func = new NativePointer(n_addr_func);</span><br></pre></td></tr></tbody></table></figure>

<h2 id="通过函数名获取指定-so-文件的函数"><a href="#通过函数名获取指定-so-文件的函数" class="headerlink" title="通过函数名获取指定 so 文件的函数"></a><strong>通过函数名获取指定 so 文件的函数</strong></h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var ptr_func = Module.findExportByName("libjnitest.so","test_add") //对函数名hook</span><br></pre></td></tr></tbody></table></figure>

<h2 id="通过-symbols-符号定位-native-方法"><a href="#通过-symbols-符号定位-native-方法" class="headerlink" title="通过 symbols 符号定位 native 方法"></a><strong>通过 symbols 符号定位 native 方法</strong></h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    var NewStringUTF_addr = null;</span><br><span class="line">    var symbols = Process.findModuleByName("libart.so").enumerateSymbols(); //使用enumerateSymbols()函数得到所有的symbols 然后对symbols中所有的对象进行遍历，然后判断语句获得目标函数的地址</span><br><span class="line">    for (var i in symbols) {</span><br><span class="line">        var symbol = symbols[i];</span><br><span class="line">        if (symbol.name.indexOf("art") &gt;= 0 &amp;&amp;</span><br><span class="line">            symbol.name.indexOf("JNI") &gt;= 0 &amp;&amp;</span><br><span class="line">            symbol.name.indexOf("CheckJNI") &lt; 0</span><br><span class="line">        ){</span><br><span class="line">            if (symbol.name.indexOf("NewStringUTF") &gt;= 0) {</span><br><span class="line">                console.log("find target symbols", symbol.name, "address is ", symbol.address);</span><br><span class="line">                NewStringUTF_addr = symbol.address;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    console.log("NewStringUTF_addr is ", NewStringUTF_addr);</span><br><span class="line">//得到函数地址之后 使用这个函数地址attach</span><br><span class="line">Interceptor.attach(NewStringUTF_addr, {</span><br><span class="line">        onEnter: function (args) {</span><br><span class="line">        },</span><br><span class="line">        onLeave: function (returnResult) {</span><br><span class="line">        }</span><br><span class="line">    })</span><br></pre></td></tr></tbody></table></figure>

<h2 id="通过-Intercept-拦截器打印-native-方法参数和返回值-并修改返回值"><a href="#通过-Intercept-拦截器打印-native-方法参数和返回值-并修改返回值" class="headerlink" title="通过 Intercept 拦截器打印 native 方法参数和返回值, 并修改返回值"></a><strong>通过 Intercept 拦截器打印 native 方法参数和返回值, 并修改返回值</strong></h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">var add_c_addr = Module.findExportByName("libnative-lib.so", "add_c");</span><br><span class="line">    console.log("add_c_addr is :",add_c_addr);</span><br><span class="line">    // 添加拦截器</span><br><span class="line">    Interceptor.attach(add_c_addr,{</span><br><span class="line">        // 打印入参</span><br><span class="line">        onEnter: function (args) {</span><br><span class="line">            console.log("add_c called");</span><br><span class="line">            console.log("arg1:",args[0].toInt32());</span><br><span class="line">            console.log("arg2", args[1].toInt32());</span><br><span class="line">        },</span><br><span class="line">        // 打印返回值</span><br><span class="line">        onLeave: function (returnValue) {</span><br><span class="line">            console.log("add_c result is :", returnValue.toInt32());</span><br><span class="line">            // 修改返回值</span><br><span class="line">            returnValue.replace(100);</span><br><span class="line">        }</span><br><span class="line">    })</span><br></pre></td></tr></tbody></table></figure>



<h2 id="获取指定-so-文件的基地址"><a href="#获取指定-so-文件的基地址" class="headerlink" title="获取指定 so 文件的基地址"></a><strong>获取指定 so 文件的基地址</strong></h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var baseAddr = Module.findBaseAddress("libnative-lib.so");</span><br><span class="line">console.log("baseAddr", baseAddr);</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Hook修改native层函数返回值为int类型的情况"><a href="#Hook修改native层函数返回值为int类型的情况" class="headerlink" title="Hook修改native层函数返回值为int类型的情况"></a><strong>Hook修改native层函数返回值为int类型的情况</strong></h2><p>使用<code>replace()</code>函数直接修改即可</p>
<p>frida脚本示例：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">import frida</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">jscode = """</span><br><span class="line">Java.perform(function(){</span><br><span class="line">    var str_name_so = "libjnitest.so";    //需要hook的so名</span><br><span class="line">    var n_addr_func_offset = 0x00000680;         //需要hook的函数的偏移</span><br><span class="line">    var n_addr_so = Module.findBaseAddress(str_name_so); //加载到内存后 函数地址 = so地址 + 函数偏移</span><br><span class="line">    var n_addr_func = parseInt(n_addr_so, 16) + n_addr_func_offset;</span><br><span class="line">    var ptr_func = new NativePointer(n_addr_func);</span><br><span class="line">    //var ptr_func = Module.findExportByName("libjnitest.so","test_add") //对函数名hook</span><br><span class="line"></span><br><span class="line">    Interceptor.attach(ptr_func,{ </span><br><span class="line">        //onEnter: 进入该函数前要执行的代码，其中args是传入的参数，一般so层函数第一个参数都是JniEnv，第二个参数是jclass，从第三个参数开始是我们java层传入的参数</span><br><span class="line">        onEnter: function(args) {</span><br><span class="line">            send("Hook start");</span><br><span class="line">            send("args[2]=" + args[2]); //第一个传入的参数</span><br><span class="line">            send("args[3]=" + args[3]); //第二个参数</span><br><span class="line">        },</span><br><span class="line">        onLeave: function(retval){ //onLeave: 该函数执行结束要执行的代码，其中retval参数即是返回值</span><br><span class="line">            send("return:"+retval); //返回值</span><br><span class="line">            retval.replace(100); //替换返回值为100</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line">"""</span><br><span class="line">def printMessage(message,data):</span><br><span class="line">    if message['type'] == 'send':</span><br><span class="line">        print('[*] {0}'.format(message['payload']))</span><br><span class="line">    else:</span><br><span class="line">        print(message)</span><br><span class="line"></span><br><span class="line">process = frida.get_remote_device().attach('com.example.testso') #进程名</span><br><span class="line">script = process.create_script(jscode)</span><br><span class="line">script.on('message',printMessage)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Hook修改native层函数返回值为string类型"><a href="#Hook修改native层函数返回值为string类型" class="headerlink" title="Hook修改native层函数返回值为string类型"></a><strong>Hook修改native层函数返回值为string类型</strong></h2><p>返回值为字符串其实是返回了一个<code>char \*</code>（字符串指针），所以简单的替换是无法取效果的</p>
<p>关键代码：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var env = Java.vm.getEnv(); //获取env对象，也就是native函数的第一个参数</span><br><span class="line">var jstrings = env.newStringUtf("tamper"); //因为返回的是字符串指针，使用我们需要构造一个newStringUtf对象，用来代替这个指针</span><br><span class="line">retval.replace(jstrings); //替换返回值</span><br></pre></td></tr></tbody></table></figure>

<p>示例</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">import frida</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">jscode = """</span><br><span class="line">Java.perform(function(){</span><br><span class="line">    Interceptor.attach(Module.findExportByName("libfridaso.so","Java_com_example_fridasostring_fridaSoString_FridaSo"),{</span><br><span class="line">        onEnter: function(args) {</span><br><span class="line">            send("Hook start");</span><br><span class="line">            send("args[2]=" + args[2]);</span><br><span class="line">        },</span><br><span class="line">        onLeave: function(retval){</span><br><span class="line">            send("return:"+retval);</span><br><span class="line">            var env = Java.vm.getEnv(); //获取env对象，也就是native函数的第一个参数</span><br><span class="line">            var jstrings = env.newStringUtf("tamper"); //因为返回的是字符串指针，使用我们需要构造一个newStringUtf对象，用来代替这个指针</span><br><span class="line">            retval.replace(jstrings); //替换返回值</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line">"""</span><br><span class="line">def printMessage(message,data):</span><br><span class="line">    if message['type'] == 'send':</span><br><span class="line">        print('[*] {0}'.format(message['payload']))</span><br><span class="line">    else:</span><br><span class="line">        print(message)</span><br><span class="line"></span><br><span class="line">process = frida.get_remote_device().attach('com.example.fridasostring')</span><br><span class="line">script = process.create_script(jscode)</span><br><span class="line">script.on('message',printMessage)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Frida命令"><a href="#Frida命令" class="headerlink" title="Frida命令"></a>Frida命令</h2><p>基础命令</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># 启动frida-server(模拟器)</span><br><span class="line">./data/local/tmp/frida-server-12.8.0-android-x86</span><br><span class="line"></span><br><span class="line"># 启动frida-server(Pixel真机)</span><br><span class="line">./data/local/tmp/frida-server-12.8.0-android-arm64</span><br><span class="line"></span><br><span class="line"># 在我的电脑之中模拟器运行frida-server(因为将这个文件导入的时候进行了重命名为frida-server)</span><br><span class="line">./data/local/tmp/frida-server</span><br><span class="line"></span><br><span class="line"># 转发端口</span><br><span class="line">adb forward tcp:27042 tcp:27042</span><br><span class="line">adb forward tcp:27043 tcp:27043</span><br><span class="line"></span><br><span class="line"># 列举出来所有连接到电脑上的设备</span><br><span class="line">frida-ls-devices</span><br><span class="line"></span><br><span class="line"># 连接到指定设备</span><br><span class="line">frida-ps -D tcp</span><br><span class="line"></span><br><span class="line"># 列举出来设备上的所有进程</span><br><span class="line">frida-ps -U</span><br><span class="line"></span><br><span class="line"># 列举出来设备上的所有应用程序</span><br><span class="line">frida-ps -Ua</span><br><span class="line"></span><br><span class="line"># 列举出来设备上的所有已安装应用程序和对应的名字</span><br><span class="line">frida-ps -Uai</span><br><span class="line"></span><br><span class="line"># 跟踪某个函数</span><br><span class="line">frida-trace -U -f Name -i "函数名"</span><br><span class="line"># frida-trace -U -f com.autonavi.minimap -i "getRequestParams"</span><br><span class="line"></span><br><span class="line"># 跟踪某个方法</span><br><span class="line">frida-trace -U -f Name -m "方法名"</span><br><span class="line"># frida-trace -U -f com.autonavi.minimap -m "MapLoader"</span><br></pre></td></tr></tbody></table></figure>



<h1 id="d3mug"><a href="#d3mug" class="headerlink" title="d3mug"></a>d3mug</h1><p>ctf之中的游戏逆向（unity3D逆向分析）</p>
<p>unity逆向的文章（里面有各种各样的有关unity的题目，可以学习一下）：<a target="_blank" rel="noopener" href="https://forum.butian.net/share/1294">https://forum.butian.net/share/1294</a></p>
<p><strong>unity游戏IL2CPP类型</strong></p>
<p>这道题是 ：IL2CPP类型相对来说，题目难度有一个质的提升。对unity的理解程度需要更深。IL2CPP的Unity3D游戏的逆向，只需要根据global-metadata.dat和libil2cpp.so来进行就可以了。</p>
<p><strong>il2cpp的内部实现文档</strong>：<a target="_blank" rel="noopener" href="https://blogs.unity3d.com/2015/05/06/an-introduction-to-ilcpp-internals/">https://blogs.unity3d.com/2015/05/06/an-introduction-to-ilcpp-internals/</a></p>
<p>il2cpp（主要分析metadata的一篇文章）</p>
<p>游戏的主页面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220305085623123.png" alt="image-20220305085623123"></p>
<p>游戏的运行界面：需要在白线的上面不停的点击这些蓝色的模块，如果能在白线的位置上点击到，那么GOOD就会增加一</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220305085823662.png" alt="image-20220305085823662"></p>
<h2 id="IL2CPPDumper"><a href="#IL2CPPDumper" class="headerlink" title="IL2CPPDumper"></a>IL2CPPDumper</h2><p>使用<strong>IL2CPPDumper这个工具</strong>将apk解包之后的<strong>global-metadata.dat</strong>和<strong>libil2cpp.so</strong>这两个文件，<strong>dump出</strong>该DLL里的所有类以及类里的方法和成员，</p>
<p>使用<a target="_blank" rel="noopener" href="https://blog.csdn.net/linxinfa/article/details/116572369">IL2CPPDumper</a>这个工具dump的方法以及dump出来的文件说明</p>
<p>dump（input文件）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220305092747884.png" alt="image-20220305092747884"></p>
<p>dump（output文件）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220305092816043.png" alt="image-20220305092816043"></p>
<p><strong>dump.cs</strong>:</p>
<p>这个文件会把<code>C#</code>的<code>dll</code>代码的类、方法、字段列出来。这里面有非常多的数据</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220305093238515.png" alt="image-20220305093238515"></p>
<p><strong>il2cpp.h</strong>：</p>
<p>生成的<code>cpp</code>的头文件，从头文件里我们也可以看到相关的数据结构</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220305093516208.png" alt="image-20220305093516208"></p>
<p><strong>script.json</strong>：</p>
<p>以<code>json</code>格式显示类的方法信息</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220305093703245.png" alt="image-20220305093703245"></p>
<p><strong>stringliteral.json</strong>：</p>
<p>以json的格式显示所有的字符串信息</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220305094319654.png" alt="image-20220305094319654"></p>
<p><strong>DummyDll/Assembly-CSharp.dll</strong></p>
<p>进入DummyDll目录，可以看到很多dll，其中就有Assembly-CSharp.dll，使用dnspy打开这个文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220305095103745.png" alt="image-20220305095103745"></p>
<p>文件列表：可以看到这里是游戏页面的初始化，组件（线），音乐等等</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220305095653171.png" alt="image-20220305095653171"></p>
<p>从上面<strong>IL2CppDumper</strong>我们可以发现，逆向得到的函数体都是空的，看不了内部逻辑。内部的逻辑结构就需要使用IDA查看libil2cpp.so这个文件，在这个文件中使用上面得到的cs文件的偏移量找到目标的函数</p>
<h2 id="关键函数定位"><a href="#关键函数定位" class="headerlink" title="关键函数定位"></a>关键函数定位</h2><p>将Il2CppDumper 处理之后得到的Assembly-CSharp.dll文件放入到dnspy之中，这个文件里面存放了这个游戏里面函数的偏移地址</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220314175022511.png" alt="image-20220314175022511"></p>
<p>根据需要查看相应的类，再查看相应的类中的函数的偏移地址</p>
<p>这里我们需要查看 GameManager和 ScoreScene类中的函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220314175327440.png" alt="image-20220314175327440"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220314175404995.png" alt="image-20220314175404995"></p>
<h2 id="游戏逻辑分析"><a href="#游戏逻辑分析" class="headerlink" title="游戏逻辑分析"></a>游戏逻辑分析</h2><p>使用上面得到的Assembly-CSharp.dll文件定位到函数的关键地址</p>
<h3 id="NoteObject类中的OnClicked-函数"><a href="#NoteObject类中的OnClicked-函数" class="headerlink" title="NoteObject类中的OnClicked()函数"></a>NoteObject类中的OnClicked()函数</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220314180743397.png" alt="image-20220314180743397"></p>
<p>再跟进这个判断时间的函数之中 它的rva是RVA = “0x62B64C” ，查看Assembly-CSharp.dll这个文件我们可以知道它就是NoteHit()函数</p>
<h3 id="GameManager类的NoteHit-函数"><a href="#GameManager类的NoteHit-函数" class="headerlink" title="GameManager类的NoteHit()函数"></a>GameManager类的NoteHit()函数</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220314180815068.png" alt="image-20220314180815068"></p>
<h3 id="GameManager类中的update-函数"><a href="#GameManager类中的update-函数" class="headerlink" title="GameManager类中的update()函数"></a>GameManager类中的update()函数</h3><p>从上面那张图中可以得到在NoteHit()函数的结尾的地方调用了update()函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220314182013914.png" alt="image-20220314182013914"></p>
<p>上面这个update()函数调用了libd3mug.so的update()函数，这个函数的最后调用了server.run</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220315210534201.png" alt="image-20220315210534201"></p>
<p>逻辑分析：点击了NodeObject是表示音游之中的方块的类，NoteObject类中的OnClicked()函数表示点击方块，之后会触发GameManager类的NoteHit()函数分析点击的时间，从而确定是否点击成功与否，该函数之后会调用GameManager类中的update()函数</p>
<p>然后查看分数的模块ScoreScene类</p>
<h3 id="ScoreScene类的get-函数"><a href="#ScoreScene类的get-函数" class="headerlink" title="ScoreScene类的get()函数"></a>ScoreScene类的get()函数</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220314183330050.png" alt="image-20220314183330050"></p>
<p>上面这个get()函数里面调用了libd3mug.so中的get()函数</p>
<h3 id="libd3mug-so中的get-函数"><a href="#libd3mug-so中的get-函数" class="headerlink" title="libd3mug.so中的get()函数"></a>libd3mug.so中的get()函数</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220315210430564.png" alt="image-20220315210430564"></p>
<p>通过这个函数交叉查询一下，找到引用该函数的函数sub_62EE40() 它便是ScoreScene类的Start()函数</p>
<h3 id="ScoreScene类的Start-函数"><a href="#ScoreScene类的Start-函数" class="headerlink" title="ScoreScene类的Start()函数"></a>ScoreScene类的Start()函数</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220314183807139.png" alt="image-20220314183807139"></p>
<p>逻辑分析：游戏结束之后会转到的类是ScoreScene类，其中最后显示分数的函数中，调用了get()函数，这样获得了一个字符串</p>
<h2 id="AssertStudio获得谱面"><a href="#AssertStudio获得谱面" class="headerlink" title="AssertStudio获得谱面"></a>AssertStudio获得谱面</h2><p>这是一个音游的游戏，由于需要我们踩点正确，所以就要我们找到这个游戏中的谱面（音乐的谱子），使用<a href="%5B(6%E6%9D%A1%E6%B6%88%E6%81%AF">AssertStudio</a> Unity解包提取资源/AssetStudio的简单使用_咲奈的平行时空-CSDN博客_unity解包](<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_21567385/article/details/107015800))%E5%8A%A0%E8%BD%BD%E8%BF%99%E4%B8%AAunity%E6%B8%B8%E6%88%8F%E7%9A%84assets%E7%9B%AE%E5%BD%95%EF%BC%8C%E5%9C%A8%E5%AE%83%E7%9A%84Asset">https://blog.csdn.net/qq_21567385/article/details/107015800))加载这个unity游戏的assets目录，在它的Asset</a> List下面我们能够看到很多资源文件，其中的hitpoints的文件就是它的谱面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220314193510893.png" alt="image-20220314193510893"></p>
<p>在这个游戏页面的首页之中我们就能够看到这个游戏的音乐是 Chromevox</p>
<p>这里有三个音乐的hitpoints 我们选择其中是Chromevox的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220314194026586.png" alt="image-20220314194026586"></p>
<p>将这个文件导出出来,这个文件之中前面表示的是轨道数，后面表示的是时间</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220314194629112.png" alt="image-20220314194629112"></p>
<p>按照之前的方法找到GameManager类的NoteMissed()函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220314195819635.png" alt="image-20220314195819635"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220314195836835.png" alt="image-20220314195836835"></p>
<p>从图中我们可以知道update()中的参数就是msecs，所以我们需要将得到的hitpoints中的msecs作为 参数传入其中，这个过程就需要frida来hook函数</p>
<h2 id="frida"><a href="#frida" class="headerlink" title="frida"></a>frida</h2><p>查看frida-server是否成功开启，-U表示USB，允许Frida检查USB设备，这时将看到一个进程列表。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/frida-d3mug%E5%A4%8D%E7%8E%B0/image-20220314205710639.png" alt="image-20220314205710639"></p>
<p>通过该命令可以得到frida脚本中所需要的文件信息(pid 和 应用名和包名)</p>
<h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">import frida, sys</span><br><span class="line"></span><br><span class="line">jscode = """</span><br><span class="line">console.log('12345')</span><br><span class="line">let hitpoints = [0, 0, 0, 146, 292, 292, 439, 512, 585, 585, 658, 731, 804, 878, 1024, 1170, 1170, 1317, 1463, 1463, 1609, 1682, 1756, 1756, 1902, 2048, 2195, 2341, 2341, 2487, 2634, 2634, 2780, 2853, 2926, 2926, 3073, 3146, 3219, 3219, 3365, 3439, 3512, 3512, 3658, 3804, 3878, 3951, 4024, 4097, 4097, 4243, 4390, 4682, 4682, 4682, 4829, 4975, 4975, 5121, 5195, 5268, 5341, 5414, 5487, 5560, 5560, 5853, 5853, 5999, 6146, 6146, 6292, 6365, 6439, 6439, 6585, 6731, 6731, 6731, 7024, 7024, 7170, 7317, 7317, 7463, 7536, 7609, 7609, 7682, 7756, 7829, 7902, 7902, 7975, 8048, 8121, 8195, 8341, 8487, 8634, 8780, 9073, 9073, 9073, 9219, 9365, 9365, 9512, 9658, 9658, 9804, 9878, 9951, 9951, 10097, 10243, 10243, 10243, 10390, 10463, 10536, 10536, 10682, 10829, 10829, 10975, 11121, 11121, 11268, 11414, 11414, 11560, 11707, 11707, 11853, 11999, 11999, 11999, 12146, 12292, 12292, 12439, 12439, 12585, 12585, 12585, 12731, 12878, 12951, 13024, 13097, 13170, 13170, 13317, 13463, 13463, 13463, 13609, 13756, 13756, 13756, 13902, 14048, 14048, 14195, 14341, 14487, 14634, 14634, 14926, 14926, 14926, 15219, 15219, 15219, 15365, 15365, 15512, 15512, 15658, 15804, 15804, 15951, 16024, 16097, 16097, 16170, 16243, 16317, 16390, 16390, 16536, 16682, 16682, 16829, 16902, 16975, 16975, 17121, 17268, 17268, 17268, 17414, 17560, 17634, 17707, 17780, 17853, 17926, 17999, 18073, 18146, 18146, 18292, 18439, 18439, 18731, 18731, 18731, 18878, 19024, 19024, 19024, 19170, 19243, 19317, 19463, 19609, 19609, 19609, 19756, 19829, 19902, 20048, 20195, 20195, 20341, 20487, 20487, 20634, 20780, 20780, 20926, 21073, 21073, 21219, 21365, 21365, 21365, 21512, 21585, 21658, 21658, 21804, 21951, 21951, 21951, 22097, 22243, 22317, 22390, 22463, 22536, 22536, 22609, 22682, 22756, 22829, 22829, 22975, 23121, 23121, 23268, 23414, 23560, 23707, 23780, 23853, 23926, 23999, 23999, 24073, 24146, 24219, 24292, 24365, 24439, 24512, 24585, 24585, 24731, 24731, 24878, 24878, 24878, 25024, 25170, 25170, 25317, 25390, 25463, 25463, 25609, 25756, 25756, 25756, 25902, 25902, 26048, 26048, 26195, 26195, 26341, 26341, 26414, 26487, 26487, 26560, 26634, 26634, 26780, 26780, 26926, 27219, 27512, 27585, 27658, 27731, 27804, 27804, 28097, 28097, 28390, 28682, 28682, 28975, 29268, 29268, 29560, 29560, 29853, 29853, 30146, 30439, 30439, 30731, 31024, 31024, 31317, 31609, 31609, 31902, 32195, 32195, 32487, 32780, 32780, 32780, 33365, 33365, 33365, 33951, 33951, 34243, 34536, 34536, 34829, 35121, 35121, 35414, 35707, 35707, 35707, 35999, 36292, 36585, 36878, 36878, 37024, 37024, 37170, 37170, 37463, 37463, 37463, 37609, 37756, 37756, 37902, 38048, 38048, 38195, 38341, 38341, 38487, 38634, 38634, 38780, 38926, 39073, 39219, 39365, 39512, 39658, 39804, 39804, 39951, 40097, 40097, 40243, 40390, 40390, 40536, 40682, 40829, 40975, 40975, 41121, 41268, 41414, 41560, 41707, 41853, 41999, 42146, 42146, 42292, 42292, 42439, 42585, 42731, 42731, 42878, 42878, 43024, 43170, 43317, 43317, 43463, 43463, 43609, 43609, 43682, 43756, 43756, 43829, 43902, 43902, 44048, 44048, 44195, 44195, 44341, 44341, 44487, 44560, 44634, 44707, 44780, 44853, 44926, 44999, 45073, 45146, 45219, 45292, 45365, 45439, 45512, 45585, 45658, 45658, 45804, 45951, 45951, 46097, 46243, 46243, 46536, 46536, 46536, 46829, 46829, 46902, 46975, 47121, 47121, 47268, 47414, 47414, 47560, 47634, 47707, 47707, 47853, 47926, 47999, 47999, 48146, 48292, 48292, 48439, 48585, 48585, 48731, 48878, 48878, 49024, 49170, 49170, 49243, 49317, 49463, 49463, 49609, 49756, 49756, 49902, 49975, 50048, 50048, 50121, 50195, 50268, 50341, 50341, 50487, 50487, 50707, 50707, 50926, 50926, 51073, 51219, 51365, 51512, 51512, 51585, 51658, 51804, 51804, 51951, 52097, 52097, 52170, 52243, 52317, 52390, 52390, 52536, 52609, 52682, 52682, 52829, 52975, 52975, 53121, 53268, 53268, 53414, 53560, 53560, 53707, 53853, 53853, 53926, 53999, 54073, 54146, 54146, 54219, 54292, 54365, 54439, 54439, 54512, 54585, 54658, 54731, 54731, 54878, 54878, 55024, 55024, 55024, 55317, 55317, 55317, 55609, 55609, 55609, 55902, 55902, 55902, 56195, 56268, 56341, 56487, 56487, 56634, 56780, 56780, 56926, 56999, 57073, 57073, 57219, 57292, 57365, 57365, 57512, 57658, 57658, 57804, 57951, 57951, 58097, 58243, 58243, 58390, 58536, 58536, 58609, 58682, 58829, 58829, 58975, 59121, 59121, 59268, 59341, 59414, 59414, 59560, 59634, 59707, 59707, 59853, 59926, 59999, 59999, 60073, 60292, 60292, 60439, 60585, 60585, 60731, 60878, 60878, 60951, 61024, 61024, 61170, 61170, 61317, 61317, 61463, 61463, 61463, 61536, 61609, 61609, 61756, 61756, 61902, 61902, 62048, 62048, 62048, 62121, 62195, 62195, 62341, 62341, 62414, 62487, 62560, 62634, 62634, 62780, 62780, 62926, 62926, 63073, 63073, 63219, 63219, 63292, 63365, 63439, 63512, 63512, 63585, 63658, 63731, 63804, 63804, 63878, 63951, 64024, 64097, 64097, 64170, 64243, 64317, 64390, 64390, 64536, 64536, 64609, 64682, 64829, 64975, 65121, 65268, 65414, 65560, 65560, 65707, 65853, 65999, 66146, 66146, 66439, 66585, 66878, 67170, 67317, 67317, 67609, 67902, 68048, 68195, 68341, 68487, 68487, 68780, 68926, 69073, 69219, 69365, 69512, 69658, 69658, 69804, 69951, 70243, 70390, 70536, 70682, 70829, 70829, 71121, 71268, 71560, 71853, 71999, 71999, 72292, 72585, 72731, 72878, 73024, 73170, 73317, 73463, 73609, 73609, 73756, 73975, 74195, 74341, 74341, 74634, 74707, 74780, 74926, 74926, 75073, 75073, 75219, 75219, 75219, 75365, 75512, 75512, 75658, 75658, 75804, 75804, 75804, 75951, 76097, 76097, 76390, 76390, 76390, 76536, 76682, 76682, 76829, 76829, 76975, 76975, 76975, 77268, 77268, 77414, 77560, 77560, 77561, 77707, 77853, 77853, 77999, 77999, 78146, 78146, 78146, 78292, 78439, 78439, 78731, 78732, 78732, 78878, 79024, 79024, 79170, 79171, 79317, 79317, 79463, 79609, 79609, 79756, 79902, 79902, 80048, 80195, 80341, 80341, 80487, 80487, 80634, 80780, 80780, 80926, 80926, 81073, 81073, 81073, 81219, 81365, 81512, 81512, 81658, 81658, 81658, 81951, 81951, 81951, 82097, 82243, 82243, 82390, 82536, 82682, 82682, 82829, 82829, 82829, 82975, 83121, 83121, 83268, 83414, 83414, 83560, 83707, 83853, 83853, 83999, 83999, 83999, 84292, 84292, 84365, 84439, 84512, 84585, 84585, 84731, 84804, 84878, 84878, 84951, 85024, 85097, 85170, 85170, 85317, 85390, 85463, 85463, 85536, 85609, 85682, 85756, 85756, 85829, 85902, 85975, 86048, 86048, 86121, 86195, 86268, 86341, 86341, 86487, 86634, 86634, 86707, 86780, 86853, 86926, 86926, 87073, 87146, 87219, 87219, 87292, 87365, 87439, 87512, 87512, 87658, 87804, 87804, 87878, 87951, 88024, 88097, 88097, 88170, 88243, 88317, 88390, 88390, 88536, 88609, 88682, 88682, 88829, 88975, 88975, 89121, 89121, 89268, 89268, 89414, 89414, 89560, 89560, 89707, 89707, 89853, 89853, 89999, 89999, 90146, 90146, 90292, 90292, 90439, 90439, 90585, 90585, 90731, 90731, 90878, 90878, 91024, 91024, 91170, 91170, 91317, 91317, 91390, 91463, 91536, 91609, 91682, 91756, 91829, 91902, 91975, 92048, 92121, 92195, 92268, 92341, 92634, 92780, 92926, 93219, 93365, 93365, 93365, 93365, 93658, 93658, 93804, 93878, 93951, 93951, 94097, 94243, 94317, 94390, 94463, 94536, 94536, 94682, 94829, 94829, 94975, 95121, 95121, 95268, 95414, 95487, 95560, 95634, 95707, 95707, 95853, 95853, 95999, 95999, 96146, 96292, 96292, 96292, 96439, 96585, 96585, 96658, 96731, 96804, 96878, 96878, 97024, 97170, 97170, 97317, 97390, 97463, 97463, 97609, 97756, 97756, 97829, 97902, 98048, 98048, 98048, 98195, 98341, 98341, 98487, 98560, 98634, 98634, 98780, 98926, 98926, 99073, 99219, 99219, 99365, 99512, 99512, 99658, 99804, 99804, 99951, 100097, 100170, 100243, 100317, 100390, 100390, 100536, 100682, 100682, 100829, 100975, 100975, 100975, 101121, 101268, 101268, 101341, 101414, 101487, 101560, 101560, 101707, 101853, 101853, 101926, 101999, 102073, 102146, 102146, 102292, 102439, 102439, 102439, 102585, 102658, 102731, 102731, 102878, 103024, 103024, 103024, 103170, 103243, 103317, 103317, 103317, 103463, 103609, 103682, 103756, 103829, 103902, 103902, 104048, 104195, 104195, 104341, 104487, 104487, 104487, 104634, 104780, 104853, 104926, 104999, 105073, 105073, 105219, 105365, 105365, 105512, 105658, 105658, 105658, 105804, 105951, 105951, 106097, 106170, 106243, 106243, 106317, 106390, 106536, 106536, 106682, 106756, 106829, 106829, 106829, 106975, 107121, 107121, 107268, 107268, 107414, 107414, 107414, 107560, 107707, 107707, 107707, 107853, 107999, 107999, 107999, 108146, 108292, 108292, 108439, 108585, 108585, 108731, 108878, 108878, 108878, 109024, 109170, 109170, 109317, 109463, 109463, 109536, 109609, 109682, 109756, 109756, 109902, 110048, 110048, 110048, 110195, 110195, 110341, 110341, 110341, 110487, 110487, 110634, 110634, 110634, 110780, 110780, 110926, 110926, 110926, 111073, 111073, 111219, 111219, 111219, 111365, 111512, 111658, 111731, 111804, 111878, 111951, 112024, 112097, 112097, 112097, 112390, 112390, 112536, 112682, 112682, 112682, 112829, 112975, 112975, 113121, 113268, 113268, 113414, 113560, 113560, 113707, 113853, 113853, 113999, 114146, 114219, 114292, 114365, 114439, 114439, 114585, 114731, 114731, 114878, 115024, 115024, 115024, 115170, 115317, 115317, 115463, 115536, 115609, 115609, 115756, 115902, 115902, 115975, 116048, 116121, 116195, 116195, 116268, 116341, 116414, 116487, 116487, 116560, 116634, 116707, 116780, 116780, 116926, 117073, 117073, 117219, 117365, 117365, 117512, 117658, 117658, 117804, 117878, 117951, 117951, 118097, 118243, 118243, 118390, 118536, 118536, 118682, 118829, 118902, 118975, 119048, 119121, 119121, 119268, 119414, 119414, 119560, 119707, 119707, 119853, 119999, 119999, 120146, 120292, 120292, 120439, 120439, 120731, 121024, 121170, 121463, 121536, 121609, 121682, 121756, 121756, 121756, 121902, 122048, 122048, 122048, 122195, 122341, 122341, 122341, 122487, 122560, 122634, 122634, 122634, 122780, 122926, 122926, 122926, 123073, 123219, 123219, 123219, 123365, 123512, 123512, 123512, 123585, 123658, 123731, 123804, 123804, 123804, 123951, 124097, 124097, 124097, 124243, 124390, 124390, 124390, 124536, 124682, 124682, 124682, 124829, 124975, 124975, 124975, 125121, 125268, 125268, 125268, 125414, 125487, 125560, 125560, 125560, 125707, 125853, 125853, 125853, 125999, 126146, 126146, 126146, 126292, 126439, 126439, 126439, 126585, 126585, 126731, 126731, 126878, 126878, 127024, 127024, 127024, 127170, 127170, 127317, 127317, 127463, 127463, 127609, 127609, 127609, 127756, 127756, 127902, 127902, 128048, 128048, 128195, 128195, 128268, 128341, 128341, 128414, 128487, 128487, 128560, 128634, 128707, 128780, 128780, 128853, 128926, 128999, 129073, 129146, 129219, 129292, 129365, 129365, 129439, 129512, 129585, 129658, 129731, 129804, 129878, 129951, 129951, 130024, 130097, 130170, 130243, 130243, 130317, 130390, 130463, 130536, 130536, 130682, 130756, 130829, 130829, 130829, 130975, 130975, 131121, 131195, 131268, 131341, 131560, 131707, 131707, 131780, 131853, 131926, 132146, 132292, 132365, 132439, 132512, 132731, 132878, 132878, 132951, 133024, 133097, 133463, 133463, 133756, 134048, 134048, 134048, 134341, 134634, 134634, 134926, 134926, 135219, 135219, 135219, 135512, 135512, 135658, 135658, 135804, 135804, 135951, 135951, 136097, 136097, 136243, 136243, 136390, 136390, 136536, 136536, 136609, 136682, 136682, 136829, 136829, 136902, 136975, 136975, 137121, 137121, 137268, 137268, 137414, 137414, 137560, 137560, 137707, 137707, 137780, 137853, 137926, 137999, 137999, 138073, 138146, 138146, 138219, 138292, 138365, 138439, 138439, 138512, 138585, 138658, 138731, 138731, 138804, 138878, 138951, 139024, 139024, 139097, 139170, 139243, 139317, 139317, 139463, 139463, 139609, 139609, 139756, 139756, 139902, 139902, 140195, 140195, 140195, 140195]</span><br><span class="line">let UpdateFunc = new NativeFunction(Module.findExportByName("libd3mug.so","update"),"void",['int'])</span><br><span class="line">for(let i=0;i&lt;hitpoints.length;i++){</span><br><span class="line">UpdateFunc(hitpoints[i]);</span><br><span class="line">}</span><br><span class="line">let GetFunc = new NativeFunction(Module.findExportByName("libd3mug.so","get"),"pointer",[]);</span><br><span class="line">var result = GetFunc();</span><br><span class="line">console.log(ptr(result));</span><br><span class="line">"""</span><br><span class="line"></span><br><span class="line">def on_message(message, data):</span><br><span class="line">    if message['type'] == 'send':</span><br><span class="line">        print("[*] {0}".format(message['payload']))</span><br><span class="line">    else:</span><br><span class="line">        print(message)</span><br><span class="line">pass</span><br><span class="line"></span><br><span class="line"># 查找USB设备并附加到目标进程</span><br><span class="line">#session = frida.get_remote_device(timeout=1000).attach(4103) # 通过命令查到的pid</span><br><span class="line"># 使用进程名称attach</span><br><span class="line"># session = frida.get_remote_device(timeout=1000).attach("LostBits")</span><br><span class="line"># 在我的电脑上能够attach的方法</span><br><span class="line">device = frida.get_remote_device()</span><br><span class="line">pid = device.spawn(['com.DefaultCompany.com.unity.template.mobile2D'])</span><br><span class="line">print(pid)</span><br><span class="line">session = device.attach(pid)</span><br><span class="line"># 在目标进程里创建脚本</span><br><span class="line">script = session.create_script(jscode)</span><br><span class="line"># 注册消息回调</span><br><span class="line">script.on('message', on_message)</span><br><span class="line">print('[*] Start attach')</span><br><span class="line"># 加载创建好的javascript脚本</span><br><span class="line">script.load()</span><br><span class="line"># 读取系统输入</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></tbody></table></figure>

<p>D3CTF{Gb78e-7b04-4364-82d2-7f44}</p>
<p>如果用解密的方法从libd3mug.so函数分析加密的结果得到flag的脚本</p>
<p>官方的解释：libd3mug.so中的算法是一个类似于feistel的东西，通过一个静态的种子初始化</p>
<p>mt19937随机数生成器，然后先生成随机数判定是否要进入下一步解密，在解密中重新生成随机数作为key，然后选取</p>
<p>一个偏移在数据中取出32字节，加密其中的16字节并将左右位置互换，将每个note的击打时间都录入update函数，即</p>
<p>可解出正确答案。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;random&gt;</span><br><span class="line">#include &lt;Windows.h&gt;</span><br><span class="line"></span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">const DWORD hitp[] = { 0,0,0,146,292,292,439,512,585,585,658,731,804,878,1024,1170,1170,1317,1463,1463,1609,1682,1756,1756,1902,2048,2195,2341,2341,2487,2634,2634,2780,2853,2926,2926,3073,3146,3219,3219,3365,3439,3512,3512,3658,3804,3878,3951,4024,4097,4097,4243,4390,4682,4682,4682,4829,4975,4975,5121,5195,5268,5341,5414,5487,5560,5560,5853,5853,5999,6146,6146,6292,6365,6439,6439,6585,6731,6731,6731,7024,7024,7170,7317,7317,7463,7536,7609,7609,7682,7756,7829,7902,7902,7975,8048,8121,8195,8341,8487,8634,8780,9073,9073,9073,9219,9365,9365,9512,9658,9658,9804,9878,9951,9951,10097,10243,10243,10243,10390,10463,10536,10536,10682,10829,10829,10975,11121,11121,11268,11414,11414,11560,11707,11707,11853,11999,11999,11999,12146,12292,12292,12439,12439,12585,12585,12585,12731,12878,12951,13024,13097,13170,13170,13317,13463,13463,13463,13609,13756,13756,13756,13902,14048,14048,14195,14341,14487,14634,14634,14926,14926,14926,15219,15219,15219,15365,15365,15512,15512,15658,15804,15804,15951,16024,16097,16097,16170,16243,16317,16390,16390,16536,16682,16682,16829,16902,16975,16975,17121,17268,17268,17268,17414,17560,17634,17707,17780,17853,17926,17999,18073,18146,18146,18292,18439,18439,18731,18731,18731,18878,19024,19024,19024,19170,19243,19317,19463,19609,19609,19609,19756,19829,19902,20048,20195,20195,20341,20487,20487,20634,20780,20780,20926,21073,21073,21219,21365,21365,21365,21512,21585,21658,21658,21804,21951,21951,21951,22097,22243,22317,22390,22463,22536,22536,22609,22682,22756,22829,22829,22975,23121,23121,23268,23414,23560,23707,23780,23853,23926,23999,23999,24073,24146,24219,24292,24365,24439,24512,24585,24585,24731,24731,24878,24878,24878,25024,25170,25170,25317,25390,25463,25463,25609,25756,25756,25756,25902,25902,26048,26048,26195,26195,26341,26341,26414,26487,26487,26560,26634,26634,26780,26780,26926,27219,27512,27585,27658,27731,27804,27804,28097,28097,28390,28682,28682,28975,29268,29268,29560,29560,29853,29853,30146,30439,30439,30731,31024,31024,31317,31609,31609,31902,32195,32195,32487,32780,32780,32780,33365,33365,33365,33951,33951,34243,34536,34536,34829,35121,35121,35414,35707,35707,35707,35999,36292,36585,36878,36878,37024,37024,37170,37170,37463,37463,37463,37609,37756,37756,37902,38048,38048,38195,38341,38341,38487,38634,38634,38780,38926,39073,39219,39365,39512,39658,39804,39804,39951,40097,40097,40243,40390,40390,40536,40682,40829,40975,40975,41121,41268,41414,41560,41707,41853,41999,42146,42146,42292,42292,42439,42585,42731,42731,42878,42878,43024,43170,43317,43317,43463,43463,43609,43609,43682,43756,43756,43829,43902,43902,44048,44048,44195,44195,44341,44341,44487,44560,44634,44707,44780,44853,44926,44999,45073,45146,45219,45292,45365,45439,45512,45585,45658,45658,45804,45951,45951,46097,46243,46243,46536,46536,46536,46829,46829,46902,46975,47121,47121,47268,47414,47414,47560,47634,47707,47707,47853,47926,47999,47999,48146,48292,48292,48439,48585,48585,48731,48878,48878,49024,49170,49170,49243,49317,49463,49463,49609,49756,49756,49902,49975,50048,50048,50121,50195,50268,50341,50341,50487,50487,50707,50707,50926,50926,51073,51219,51365,51512,51512,51585,51658,51804,51804,51951,52097,52097,52170,52243,52317,52390,52390,52536,52609,52682,52682,52829,52975,52975,53121,53268,53268,53414,53560,53560,53707,53853,53853,53926,53999,54073,54146,54146,54219,54292,54365,54439,54439,54512,54585,54658,54731,54731,54878,54878,55024,55024,55024,55317,55317,55317,55609,55609,55609,55902,55902,55902,56195,56268,56341,56487,56487,56634,56780,56780,56926,56999,57073,57073,57219,57292,57365,57365,57512,57658,57658,57804,57951,57951,58097,58243,58243,58390,58536,58536,58609,58682,58829,58829,58975,59121,59121,59268,59341,59414,59414,59560,59634,59707,59707,59853,59926,59999,59999,60073,60292,60292,60439,60585,60585,60731,60878,60878,60951,61024,61024,61170,61170,61317,61317,61463,61463,61463,61536,61609,61609,61756,61756,61902,61902,62048,62048,62048,62121,62195,62195,62341,62341,62414,62487,62560,62634,62634,62780,62780,62926,62926,63073,63073,63219,63219,63292,63365,63439,63512,63512,63585,63658,63731,63804,63804,63878,63951,64024,64097,64097,64170,64243,64317,64390,64390,64536,64536,64609,64682,64829,64975,65121,65268,65414,65560,65560,65707,65853,65999,66146,66146,66439,66585,66878,67170,67317,67317,67609,67902,68048,68195,68341,68487,68487,68780,68926,69073,69219,69365,69512,69658,69658,69804,69951,70243,70390,70536,70682,70829,70829,71121,71268,71560,71853,71999,71999,72292,72585,72731,72878,73024,73170,73317,73463,73609,73609,73756,73975,74195,74341,74341,74634,74707,74780,74926,74926,75073,75073,75219,75219,75219,75365,75512,75512,75658,75658,75804,75804,75804,75951,76097,76097,76390,76390,76390,76536,76682,76682,76829,76829,76975,76975,76975,77268,77268,77414,77560,77560,77561,77707,77853,77853,77999,77999,78146,78146,78146,78292,78439,78439,78731,78732,78732,78878,79024,79024,79170,79171,79317,79317,79463,79609,79609,79756,79902,79902,80048,80195,80341,80341,80487,80487,80634,80780,80780,80926,80926,81073,81073,81073,81219,81365,81512,81512,81658,81658,81658,81951,81951,81951,82097,82243,82243,82390,82536,82682,82682,82829,82829,82829,82975,83121,83121,83268,83414,83414,83560,83707,83853,83853,83999,83999,83999,84292,84292,84365,84439,84512,84585,84585,84731,84804,84878,84878,84951,85024,85097,85170,85170,85317,85390,85463,85463,85536,85609,85682,85756,85756,85829,85902,85975,86048,86048,86121,86195,86268,86341,86341,86487,86634,86634,86707,86780,86853,86926,86926,87073,87146,87219,87219,87292,87365,87439,87512,87512,87658,87804,87804,87878,87951,88024,88097,88097,88170,88243,88317,88390,88390,88536,88609,88682,88682,88829,88975,88975,89121,89121,89268,89268,89414,89414,89560,89560,89707,89707,89853,89853,89999,89999,90146,90146,90292,90292,90439,90439,90585,90585,90731,90731,90878,90878,91024,91024,91170,91170,91317,91317,91390,91463,91536,91609,91682,91756,91829,91902,91975,92048,92121,92195,92268,92341,92634,92780,92926,93219,93365,93365,93365,93365,93658,93658,93804,93878,93951,93951,94097,94243,94317,94390,94463,94536,94536,94682,94829,94829,94975,95121,95121,95268,95414,95487,95560,95634,95707,95707,95853,95853,95999,95999,96146,96292,96292,96292,96439,96585,96585,96658,96731,96804,96878,96878,97024,97170,97170,97317,97390,97463,97463,97609,97756,97756,97829,97902,98048,98048,98048,98195,98341,98341,98487,98560,98634,98634,98780,98926,98926,99073,99219,99219,99365,99512,99512,99658,99804,99804,99951,100097,100170,100243,100317,100390,100390,100536,100682,100682,100829,100975,100975,100975,101121,101268,101268,101341,101414,101487,101560,101560,101707,101853,101853,101926,101999,102073,102146,102146,102292,102439,102439,102439,102585,102658,102731,102731,102878,103024,103024,103024,103170,103243,103317,103317,103317,103463,103609,103682,103756,103829,103902,103902,104048,104195,104195,104341,104487,104487,104487,104634,104780,104853,104926,104999,105073,105073,105219,105365,105365,105512,105658,105658,105658,105804,105951,105951,106097,106170,106243,106243,106317,106390,106536,106536,106682,106756,106829,106829,106829,106975,107121,107121,107268,107268,107414,107414,107414,107560,107707,107707,107707,107853,107999,107999,107999,108146,108292,108292,108439,108585,108585,108731,108878,108878,108878,109024,109170,109170,109317,109463,109463,109536,109609,109682,109756,109756,109902,110048,110048,110048,110195,110195,110341,110341,110341,110487,110487,110634,110634,110634,110780,110780,110926,110926,110926,111073,111073,111219,111219,111219,111365,111512,111658,111731,111804,111878,111951,112024,112097,112097,112097,112390,112390,112536,112682,112682,112682,112829,112975,112975,113121,113268,113268,113414,113560,113560,113707,113853,113853,113999,114146,114219,114292,114365,114439,114439,114585,114731,114731,114878,115024,115024,115024,115170,115317,115317,115463,115536,115609,115609,115756,115902,115902,115975,116048,116121,116195,116195,116268,116341,116414,116487,116487,116560,116634,116707,116780,116780,116926,117073,117073,117219,117365,117365,117512,117658,117658,117804,117878,117951,117951,118097,118243,118243,118390,118536,118536,118682,118829,118902,118975,119048,119121,119121,119268,119414,119414,119560,119707,119707,119853,119999,119999,120146,120292,120292,120439,120439,120731,121024,121170,121463,121536,121609,121682,121756,121756,121756,121902,122048,122048,122048,122195,122341,122341,122341,122487,122560,122634,122634,122634,122780,122926,122926,122926,123073,123219,123219,123219,123365,123512,123512,123512,123585,123658,123731,123804,123804,123804,123951,124097,124097,124097,124243,124390,124390,124390,124536,124682,124682,124682,124829,124975,124975,124975,125121,125268,125268,125268,125414,125487,125560,125560,125560,125707,125853,125853,125853,125999,126146,126146,126146,126292,126439,126439,126439,126585,126585,126731,126731,126878,126878,127024,127024,127024,127170,127170,127317,127317,127463,127463,127609,127609,127609,127756,127756,127902,127902,128048,128048,128195,128195,128268,128341,128341,128414,128487,128487,128560,128634,128707,128780,128780,128853,128926,128999,129073,129146,129219,129292,129365,129365,129439,129512,129585,129658,129731,129804,129878,129951,129951,130024,130097,130170,130243,130243,130317,130390,130463,130536,130536,130682,130756,130829,130829,130829,130975,130975,131121,131195,131268,131341,131560,131707,131707,131780,131853,131926,132146,132292,132365,132439,132512,132731,132878,132878,132951,133024,133097,133463,133463,133756,134048,134048,134048,134341,134634,134634,134926,134926,135219,135219,135219,135512,135512,135658,135658,135804,135804,135951,135951,136097,136097,136243,136243,136390,136390,136536,136536,136609,136682,136682,136829,136829,136902,136975,136975,137121,137121,137268,137268,137414,137414,137560,137560,137707,137707,137780,137853,137926,137999,137999,138073,138146,138146,138219,138292,138365,138439,138439,138512,138585,138658,138731,138731,138804,138878,138951,139024,139024,139097,139170,139243,139317,139317,139463,139463,139609,139609,139756,139756,139902,139902,140195,140195,140195,140195 };</span><br><span class="line"></span><br><span class="line">DWORD __ROR4__(DWORD a1, char a2)</span><br><span class="line">{</span><br><span class="line">  return (a1 &gt;&gt; a2) | (a1 &lt;&lt; (32 - a2));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">int rounds(uint8_t* bytes, unsigned int a2, int a3)</span><br><span class="line">{</span><br><span class="line">  DWORD* v3; // r4</span><br><span class="line">  DWORD v4; // r12</span><br><span class="line">  DWORD v5[2]; // r5</span><br><span class="line">  DWORD v6; // r3</span><br><span class="line">  DWORD result; // r0</span><br><span class="line"></span><br><span class="line">  v3 = (DWORD*)((char*)bytes + a3);</span><br><span class="line">  v4 = *(DWORD*)((char*)bytes + a3);</span><br><span class="line">  *(DWORD64*)&amp;v5[0] = *(DWORD64*)((char*)bytes + a3 + 4);</span><br><span class="line">  v6 = *(DWORD*)((char*)bytes + a3 + 12);</span><br><span class="line">  *(DWORD*)((char*)bytes + a3) = *(&amp;v5[0] + 1);</span><br><span class="line">  result = v4 ^ __ROR4__(*(&amp;v5[0] + 1) ^ a2, 19);</span><br><span class="line">  v3[3] = v5[0] ^ __ROR4__(v6, 18) ^ __ROR4__(*(&amp;v5[0] + 1) ^ a2, 19);</span><br><span class="line">  v3[1] = v6;</span><br><span class="line">  v3[2] = result;</span><br><span class="line">  return result;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">int main(int argc, char const* argv[])</span><br><span class="line">{</span><br><span class="line">  unsigned char enc_bytes[] =</span><br><span class="line">  {</span><br><span class="line">    0x3C, 0xAC, 0x92, 0x6F, 0x44, 0xA1, 0xC1, 0x17, 0xFD, 0x62,</span><br><span class="line">    0x60, 0xDD, 0x63, 0xF8, 0xE3, 0x2A, 0x5E, 0x75, 0x78, 0xBE,</span><br><span class="line">    0x59, 0x46, 0x33, 0xF6, 0x2E, 0x64, 0x61, 0x8A, 0x27, 0x93,</span><br><span class="line">    0x21, 0x7D, 0x00</span><br><span class="line">  };</span><br><span class="line">  mt19937 rng(-196167794);</span><br><span class="line">  for (int i = 0; i &lt; 1608; ++i)</span><br><span class="line">  {</span><br><span class="line">    if (rng() % 7 &gt;= 3)</span><br><span class="line">    {</span><br><span class="line">      rounds(enc_bytes, rng(), hitp[i] &amp; 0xF);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  printf("%s\n", enc_bytes);</span><br><span class="line">  getchar();</span><br><span class="line">  return 0;</span><br><span class="line">}</span><br><span class="line">D3CTF{Gb78e-7b04-4364-82d2-7f44}</span><br></pre></td></tr></tbody></table></figure>

<p>最后得到flag：D3CTF{Gb78e-7b04-4364-82d2-7f44}</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Gruge</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/03/17/frida-d3mug%E5%A4%8D%E7%8E%B0/">http://example.com/2022/03/17/frida-d3mug%E5%A4%8D%E7%8E%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Gruge's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%A4%8D%E7%8E%B0/">复现</a><a class="post-meta__tags" href="/tags/frida/">frida</a></div><div class="post_share"><div class="social-share" data-image="https://s3.bmp.ovh/imgs/2022/02/ca6f47126f533a59.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/03/20/DASCTF-Oct/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2022/02/ca6f47126f533a59.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">DASCTF_Oct</div></div></a></div><div class="next-post pull-right"><a href="/2022/03/10/AntCTF-D%CB%863CTF-2022%EF%BC%88d3arm-d3w0w%EF%BC%89/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2022/02/ca6f47126f533a59.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">AntCTF &amp; Dˆ3CTF 2022（d3arm+d3w0w）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/04/05/2022DASCTF-X-SU-StarGate/" title="2022DASCTF_X_SU_StarGate"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2022/02/ca6f47126f533a59.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-05</div><div class="title">2022DASCTF_X_SU_StarGate</div></div></a></div><div><a href="/2022/02/25/VNCTF-2022/" title="VNCTF_2022"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2022/02/ca6f47126f533a59.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-25</div><div class="title">VNCTF_2022</div></div></a></div><div><a href="/2022/04/13/starCTF/" title="starCTF2021"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2022/02/ca6f47126f533a59.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-13</div><div class="title">starCTF2021</div></div></a></div><div><a href="/2022/03/29/%E9%99%87%E5%8E%9F%E6%88%98%E7%96%AB2021%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B/" title="陇原战疫2021网络安全大赛"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2022/02/ca6f47126f533a59.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-29</div><div class="title">陇原战疫2021网络安全大赛</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2022/02/463b631c6a0f63ec.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info__name">Gruge</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">28</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#FRIDA-API%E4%BD%BF%E7%94%A8%E7%AF%87"><span class="toc-number">1.</span> <span class="toc-text">FRIDA-API使用篇</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Java%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.1.</span> <span class="toc-text">Java对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%84%E5%8A%A0%E8%B0%83%E7%94%A8Java-perform"><span class="toc-number">1.1.1.</span> <span class="toc-text">附加调用Java.perform</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E5%8A%A0%E8%BD%BDJava-available"><span class="toc-number">1.1.2.</span> <span class="toc-text">判断加载Java.available</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E5%8F%B7Java-androidVersion"><span class="toc-number">1.1.3.</span> <span class="toc-text">版本号Java.androidVersion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%B1%BBJava-use"><span class="toc-number">1.1.4.</span> <span class="toc-text">获取类Java.use</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E7%B1%BBJava-enumerateLoadedClasses"><span class="toc-number">1.1.5.</span> <span class="toc-text">枚举类Java.enumerateLoadedClasses</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%AB%E6%8F%8F%E5%AE%9E%E4%BE%8B%E7%B1%BBJava-choose"><span class="toc-number">1.1.6.</span> <span class="toc-text">扫描实例类Java.choose</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E5%99%A8Java-cast"><span class="toc-number">1.1.7.</span> <span class="toc-text">类型转换器Java.cast</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E4%BB%BB%E6%84%8F%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8BJava-array"><span class="toc-number">1.1.8.</span> <span class="toc-text">定义任意数组类型Java.array</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-vm%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.1.9.</span> <span class="toc-text">Java.vm对象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Interceptor%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.2.</span> <span class="toc-text">Interceptor对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Interceptor-attach"><span class="toc-number">1.2.1.</span> <span class="toc-text">Interceptor.attach</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Interceptor-detachAll"><span class="toc-number">1.2.2.</span> <span class="toc-text">Interceptor.detachAll</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Interceptor-replace"><span class="toc-number">1.2.3.</span> <span class="toc-text">Interceptor.replace</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NativePointer%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.3.</span> <span class="toc-text">NativePointer对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#new-NativePointer-s"><span class="toc-number">1.3.1.</span> <span class="toc-text">new NativePointer(s)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E7%AE%97%E7%AC%A6%E4%BB%A5%E5%8F%8A%E6%8C%87%E9%92%88%E8%AF%BB%E5%86%99API"><span class="toc-number">1.3.2.</span> <span class="toc-text">运算符以及指针读写API</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NativeFunction%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.4.</span> <span class="toc-text">NativeFunction对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NativeCallback%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.5.</span> <span class="toc-text">NativeCallback对象</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#FRIDA-API%E4%BD%BF%E7%94%A8%E7%AF%87%EF%BC%9Arpc%E3%80%81Process%E3%80%81Module%E3%80%81Memory"><span class="toc-number">2.</span> <span class="toc-text">FRIDA-API使用篇：rpc、Process、Module、Memory</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#FRIDA%E8%BE%93%E5%87%BA%E6%89%93%E5%8D%B0"><span class="toc-number">2.1.</span> <span class="toc-text">FRIDA输出打印</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#console%E8%BE%93%E5%87%BA"><span class="toc-number">2.1.1.</span> <span class="toc-text">console输出</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#console%E4%B9%8Bhexdump"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">console之hexdump</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#send"><span class="toc-number">2.1.2.</span> <span class="toc-text">send</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FRIDA%E5%8F%98%E9%87%8F%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.2.</span> <span class="toc-text">FRIDA变量类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E5%8F%98%E9%87%8F%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.2.1.</span> <span class="toc-text">声明变量类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Int64-v-%E4%BD%BF%E7%94%A8%E7%9A%84API"><span class="toc-number">2.2.2.</span> <span class="toc-text">Int64(v)使用的API</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Process%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.3.</span> <span class="toc-text">Process对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Process-id"><span class="toc-number">2.3.1.</span> <span class="toc-text">Process.id</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Process-isDebuggerAttached"><span class="toc-number">2.3.2.</span> <span class="toc-text">Process.isDebuggerAttached()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Process-enumerateModules"><span class="toc-number">2.3.3.</span> <span class="toc-text">Process.enumerateModules()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Process-enumerateThreads"><span class="toc-number">2.3.4.</span> <span class="toc-text">Process.enumerateThreads()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Process-getCurrentThreadId"><span class="toc-number">2.3.5.</span> <span class="toc-text">Process.getCurrentThreadId()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Module%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.4.</span> <span class="toc-text">Module对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Module%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-number">2.4.1.</span> <span class="toc-text">Module对象的属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Module%E5%AF%B9%E8%B1%A1%E7%9A%84API"><span class="toc-number">2.4.2.</span> <span class="toc-text">Module对象的API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#enumerateImports"><span class="toc-number">2.4.3.</span> <span class="toc-text">enumerateImports()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#enumerateExports"><span class="toc-number">2.4.4.</span> <span class="toc-text">enumerateExports()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#enumerateSymbols"><span class="toc-number">2.4.5.</span> <span class="toc-text">enumerateSymbols()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Module-findExportByName-exportName-Module-getExportByName-exportName"><span class="toc-number">2.4.6.</span> <span class="toc-text">Module.findExportByName(exportName), Module.getExportByName(exportName)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Module-findBaseAddress-name-%E3%80%81Module-getBaseAddress-name"><span class="toc-number">2.4.7.</span> <span class="toc-text">Module.findBaseAddress(name)、Module.getBaseAddress(name)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Memory%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.5.</span> <span class="toc-text">Memory对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Memory-scan%E6%90%9C%E7%B4%A2%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE"><span class="toc-number">2.5.1.</span> <span class="toc-text">Memory.scan搜索内存数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%88%86%E9%85%8DMemory-alloc"><span class="toc-number">2.5.2.</span> <span class="toc-text">内存分配Memory.alloc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%A4%8D%E5%88%B6Memory-copy"><span class="toc-number">2.5.3.</span> <span class="toc-text">内存复制Memory.copy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98Memory-writeByteArray%E2%80%99"><span class="toc-number">2.5.4.</span> <span class="toc-text">写入内存Memory.writeByteArray’</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E5%86%85%E5%AD%98Memory-readByteArray"><span class="toc-number">2.5.5.</span> <span class="toc-text">读取内存Memory.readByteArray</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#frida%E7%9A%84so%E5%87%BD%E6%95%B0hook"><span class="toc-number">3.</span> <span class="toc-text">frida的so函数hook</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%87%BD%E6%95%B0%E5%9C%B0%E5%9D%80%E8%8E%B7%E5%8F%96%E6%8C%87%E5%AE%9A-so-%E6%96%87%E4%BB%B6%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">3.1.</span> <span class="toc-text">通过函数地址获取指定 so 文件的函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%87%BD%E6%95%B0%E5%90%8D%E8%8E%B7%E5%8F%96%E6%8C%87%E5%AE%9A-so-%E6%96%87%E4%BB%B6%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">3.2.</span> <span class="toc-text">通过函数名获取指定 so 文件的函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-symbols-%E7%AC%A6%E5%8F%B7%E5%AE%9A%E4%BD%8D-native-%E6%96%B9%E6%B3%95"><span class="toc-number">3.3.</span> <span class="toc-text">通过 symbols 符号定位 native 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-Intercept-%E6%8B%A6%E6%88%AA%E5%99%A8%E6%89%93%E5%8D%B0-native-%E6%96%B9%E6%B3%95%E5%8F%82%E6%95%B0%E5%92%8C%E8%BF%94%E5%9B%9E%E5%80%BC-%E5%B9%B6%E4%BF%AE%E6%94%B9%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">3.4.</span> <span class="toc-text">通过 Intercept 拦截器打印 native 方法参数和返回值, 并修改返回值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%8C%87%E5%AE%9A-so-%E6%96%87%E4%BB%B6%E7%9A%84%E5%9F%BA%E5%9C%B0%E5%9D%80"><span class="toc-number">3.5.</span> <span class="toc-text">获取指定 so 文件的基地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hook%E4%BF%AE%E6%94%B9native%E5%B1%82%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E5%80%BC%E4%B8%BAint%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%83%85%E5%86%B5"><span class="toc-number">3.6.</span> <span class="toc-text">Hook修改native层函数返回值为int类型的情况</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hook%E4%BF%AE%E6%94%B9native%E5%B1%82%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E5%80%BC%E4%B8%BAstring%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.7.</span> <span class="toc-text">Hook修改native层函数返回值为string类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Frida%E5%91%BD%E4%BB%A4"><span class="toc-number">3.8.</span> <span class="toc-text">Frida命令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#d3mug"><span class="toc-number">4.</span> <span class="toc-text">d3mug</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IL2CPPDumper"><span class="toc-number">4.1.</span> <span class="toc-text">IL2CPPDumper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E5%87%BD%E6%95%B0%E5%AE%9A%E4%BD%8D"><span class="toc-number">4.2.</span> <span class="toc-text">关键函数定位</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%B8%E6%88%8F%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90"><span class="toc-number">4.3.</span> <span class="toc-text">游戏逻辑分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NoteObject%E7%B1%BB%E4%B8%AD%E7%9A%84OnClicked-%E5%87%BD%E6%95%B0"><span class="toc-number">4.3.1.</span> <span class="toc-text">NoteObject类中的OnClicked()函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GameManager%E7%B1%BB%E7%9A%84NoteHit-%E5%87%BD%E6%95%B0"><span class="toc-number">4.3.2.</span> <span class="toc-text">GameManager类的NoteHit()函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GameManager%E7%B1%BB%E4%B8%AD%E7%9A%84update-%E5%87%BD%E6%95%B0"><span class="toc-number">4.3.3.</span> <span class="toc-text">GameManager类中的update()函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ScoreScene%E7%B1%BB%E7%9A%84get-%E5%87%BD%E6%95%B0"><span class="toc-number">4.3.4.</span> <span class="toc-text">ScoreScene类的get()函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#libd3mug-so%E4%B8%AD%E7%9A%84get-%E5%87%BD%E6%95%B0"><span class="toc-number">4.3.5.</span> <span class="toc-text">libd3mug.so中的get()函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ScoreScene%E7%B1%BB%E7%9A%84Start-%E5%87%BD%E6%95%B0"><span class="toc-number">4.3.6.</span> <span class="toc-text">ScoreScene类的Start()函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AssertStudio%E8%8E%B7%E5%BE%97%E8%B0%B1%E9%9D%A2"><span class="toc-number">4.4.</span> <span class="toc-text">AssertStudio获得谱面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#frida"><span class="toc-number">4.5.</span> <span class="toc-text">frida</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC"><span class="toc-number">4.6.</span> <span class="toc-text">脚本</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/04/21/DASCTF-Login/" title="DASCTF_Login"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2022/02/ca6f47126f533a59.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DASCTF_Login"></a><div class="content"><a class="title" href="/2022/04/21/DASCTF-Login/" title="DASCTF_Login">DASCTF_Login</a><time datetime="2022-04-21T06:04:38.000Z" title="发表于 2022-04-21 14:04:38">2022-04-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/15/HFCTF2022-theShellcode/" title="HFCTF2022_theShellcode"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2022/02/ca6f47126f533a59.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="HFCTF2022_theShellcode"></a><div class="content"><a class="title" href="/2022/04/15/HFCTF2022-theShellcode/" title="HFCTF2022_theShellcode">HFCTF2022_theShellcode</a><time datetime="2022-04-15T14:35:25.000Z" title="发表于 2022-04-15 22:35:25">2022-04-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/13/starCTF/" title="starCTF2021"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2022/02/ca6f47126f533a59.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="starCTF2021"></a><div class="content"><a class="title" href="/2022/04/13/starCTF/" title="starCTF2021">starCTF2021</a><time datetime="2022-04-13T01:20:26.000Z" title="发表于 2022-04-13 09:20:26">2022-04-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/05/2022DASCTF-X-SU-StarGate/" title="2022DASCTF_X_SU_StarGate"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2022/02/ca6f47126f533a59.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2022DASCTF_X_SU_StarGate"></a><div class="content"><a class="title" href="/2022/04/05/2022DASCTF-X-SU-StarGate/" title="2022DASCTF_X_SU_StarGate">2022DASCTF_X_SU_StarGate</a><time datetime="2022-04-05T14:46:18.000Z" title="发表于 2022-04-05 22:46:18">2022-04-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/29/%E9%99%87%E5%8E%9F%E6%88%98%E7%96%AB2021%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B/" title="陇原战疫2021网络安全大赛"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2022/02/ca6f47126f533a59.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="陇原战疫2021网络安全大赛"></a><div class="content"><a class="title" href="/2022/03/29/%E9%99%87%E5%8E%9F%E6%88%98%E7%96%AB2021%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B/" title="陇原战疫2021网络安全大赛">陇原战疫2021网络安全大赛</a><time datetime="2022-03-29T05:20:37.000Z" title="发表于 2022-03-29 13:20:37">2022-03-29</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">©2022 By Gruge</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '1aa3bac2fd8cfac9d7c3',
      clientSecret: '7640d6d45e9030f665c75a640991b67e8367e67d',
      repo: 'G2uge.github.io',
      owner: 'G2uge',
      admin: ['G2uge'],
      id: '2c2c9ac77cf9222784b576ab9d7e8189',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zindex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>